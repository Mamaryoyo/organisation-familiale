<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Organisation familiale</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f6f7f9; --panel:#ffffff; --text:#2e2e2e; --muted:#6b7280; --line:#e5e7eb;
    --blue:#2563eb; --yellow:#facc15; --green:#22c55e; --orange:#f59e0b; --red:#ef4444;
    --red-soft:#fee2e2; --red-soft-dark:rgba(239,68,68,.18);
    --card:#ffffff; --card-soft:#f3f4f6; --shadow:0 1px 3px rgba(0,0,0,.08);
  }
  body.dark{
    --bg:#1f1f23; --panel:#2b2b31; --text:#e5e5e5; --muted:#9ca3af; --line:#3b3b45;
    --card:#2b2b31; --card-soft:#3a3a42; --shadow:0 1px 3px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Helvetica Neue",Arial,sans-serif;
    background:var(--bg); color:var(--text); display:flex; height:100vh; overflow:hidden;
    transition:background .3s,color .3s;
  }

  .app{display:flex; flex:1; width:100%; height:100%;}
  .left{flex:2; display:flex; flex-direction:column; border-right:1px solid var(--line); min-width:560px;}
  .right{flex:1; display:flex; flex-direction:column; min-width:360px;}

  .bar{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5}
  .title{font-weight:600; font-size:18px}
  .sub{font-size:13px; color:var(--muted)}
  .bar-left{display:flex; flex-direction:column; gap:2px}
  .bar-right{display:flex; align-items:center; gap:8px}
  .btn{background:var(--panel); border:1px solid var(--line); padding:6px 10px; border-radius:8px; cursor:pointer; box-shadow:var(--shadow); color:var(--text)}
  .btn:hover{filter:brightness(0.98)}
  .icon{background:var(--panel); border:1px solid var(--line); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:18px; line-height:1; box-shadow:var(--shadow); color:var(--text)}

  .week-wrap{flex:1; overflow:hidden; background:var(--panel)}
  .week-view{display:flex; gap:8px; padding:12px; transform:translateX(0); transition:transform .35s ease}
  .day{flex:1; background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; display:flex; flex-direction:column; align-items:stretch; box-shadow:var(--shadow); min-width:0}
  .day-head{display:flex; flex-direction:column; align-items:center; margin-bottom:8px}
  .weekday{font-size:16px; font-weight:400; text-transform:capitalize}
  .date{font-size:13px; color:var(--muted)}
  .today-ring{border:2px solid var(--blue); border-radius:10px; padding:2px 6px}
  .pill{margin-top:6px; background:var(--panel); border-radius:10px; padding:8px; font-size:12px; border-left:6px solid #ccc; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; gap:8px}
  .pill .badge{font-size:11px; padding:2px 6px; border-radius:999px; background:#e5e7eb; color:#111}
  body.dark .pill .badge{background:#444; color:#eee}
  .pill.yonice{border-left-color:var(--blue)}
  .pill.marine{border-left-color:var(--yellow)}
  .absent{background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.08)); outline:1px dashed rgba(239,68,68,.6);}
  .day-foot{margin-top:auto; display:flex; flex-direction:column; align-items:center; gap:6px}
  .load-chip{font-size:11px; color:var(--muted); background:var(--card-soft); border:1px solid var(--line); border-radius:999px; padding:2px 8px}
  .load-bar{height:6px; width:80%; border-radius:4px; background:var(--line); overflow:hidden}
  .load-fill{height:100%; border-radius:4px}

  .month{background:var(--panel); border-top:1px solid var(--line); padding:10px 12px}
  .month-top{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:6px}
  .month-title{font-weight:600; flex:1; text-align:center}
  .days-head{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:6px; color:var(--muted); font-size:11px; text-align:center}
  .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .cell{
    width:34px; height:34px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:12px; cursor:pointer; user-select:none;
    background:transparent; border:1px solid var(--line); color:var(--text);
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
  }
  .cell:hover{transform:scale(1.04)}
  .cell.today{box-shadow:0 0 0 2px var(--blue) inset; border-color:var(--blue); font-weight:700}
  .cell.wknd{background:var(--card-soft); color:var(--muted)}
  .cell.abs{background:var(--red); color:#fff; border-color:var(--red)}

  .right-head{padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line)}
  .tasks{flex:1; padding:12px; display:grid; grid-template-columns:repeat(3,1fr); gap:10px; overflow:auto}
  .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; text-align:center; box-shadow:var(--shadow); cursor:pointer; transition:transform .12s ease, opacity .25s ease}
  .card:hover{transform:translateY(-1px)}
  .card.fade{opacity:0; transform:scale(.9)}
  .name{font-weight:600; font-size:14px; margin:0}
  .meta{font-size:12px; color:var(--muted); margin-top:4px}
  .days{font-weight:800; font-size:26px; margin-top:6px}
  .upcoming{background:var(--card-soft)}
  body.dark .upcoming{background:var(--card)}
  .late{background:var(--red-soft); border-color:var(--red)}
  body.dark .late{background:var(--red-soft-dark); border-color:var(--red); color:#fca5a5}

  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); backdrop-filter:blur(6px); z-index:20}
  .dialog{background:var(--panel); color:var(--text); padding:18px; border-radius:12px; width:min(360px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .dialog h3{margin:0 0 12px 0; font-size:16px; font-weight:600; text-align:center}
  .who{display:flex; gap:10px}
  .wbtn{flex:1; padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:700}
  .wbtn.yonice{background:var(--blue); color:#fff}
  .wbtn.marine{background:var(--yellow); color:#333}

  .panel{position:fixed; top:0; right:-380px; width:380px; height:100%; background:var(--panel); border-left:1px solid var(--line); box-shadow:-4px 0 12px rgba(0,0,0,.12); transition:right .28s ease; z-index:25; display:flex; flex-direction:column}
  .panel.open{right:0}
  .p-head{padding:14px; border-bottom:1px solid var(--line); font-weight:700}
  .p-body{padding:14px; overflow:auto; display:flex; flex-direction:column; gap:12px}
  label{font-size:12px; color:var(--muted)}
  input,select{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:var(--card); color:var(--text)}
  hr{border:none; border-top:1px solid var(--line); margin:6px 0}
  .row{display:flex; gap:8px}
  .row > *{flex:1}

  .chart{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:var(--shadow)}

  @media (max-width:980px){ .left{min-width:0} .right{min-width:0} .tasks{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:720px){ .app{flex-direction:column} .tasks{grid-template-columns:1fr} }
</style>
<!-- Google API (gapi) -->
<script src="https://apis.google.com/js/api.js?onload=gapiInit" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <div class="left">
      <div class="bar">
        <div class="bar-left">
          <div class="title" id="weekTitle">Semaine</div>
          <div class="sub" id="weekSub"></div>
        </div>
        <div class="bar-right">
          <button class="btn" id="prevW" title="Semaine pr√©c√©dente">‚Äπ</button>
          <button class="btn" id="todayBtn" title="Revenir √† aujourd‚Äôhui">Aujourd‚Äôhui</button>
          <button class="btn" id="nextW" title="Semaine suivante">‚Ä∫</button>
          <button class="btn" id="autoBtn" title="R√©partir la semaine">‚ÜîÔ∏è</button>
          <button class="icon" id="absenceBtn" title="Absences">üíº</button>
          <button class="icon" id="statsBtn" title="Statistiques">üìà</button>
          <button class="icon" id="settingsBtn" title="Param√®tres">‚öôÔ∏è</button>
        </div>
      </div>

      <div class="week-wrap">
        <div class="week-view" id="weekView"></div>
      </div>

      <!-- Panneau absences (repliable) -->
      <div class="month" id="absencePanel" style="display:none">
        <div class="month-top">
          <button class="btn" id="prevM" title="Mois pr√©c√©dent">‚Äπ</button>
          <div class="month-title" id="monthTitle">Mois</div>
          <button class="btn" id="nextM" title="Mois suivant">‚Ä∫</button>
          <button class="btn" id="closeAbs" title="Fermer">‚úñ</button>
        </div>
        <div class="days-head"><div>lu</div><div>ma</div><div>me</div><div>je</div><div>ve</div><div>sa</div><div>di</div></div>
        <div class="grid" id="monthGrid"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="right-head">
        <div class="title" style="font-size:16px">9 prochaines t√¢ches</div>
        <div class="sub">Appuie pour valider (popup Yonice / Marine)</div>
      </div>
      <div class="tasks" id="tasksGrid"></div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="dialog">
      <h3 id="modalTaskName">Qui a fait‚Ä¶ ?</h3>
      <div class="who">
        <button class="wbtn yonice" id="whoYonice">Yonice</button>
        <button class="wbtn marine" id="whoMarine">Marine</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="panel" id="settingsPanel">
    <div class="p-head">Param√®tres</div>
    <div class="p-body">
      <button class="btn" id="themeToggle">Basculer clair / sombre</button>
      <div>
        <label><input type="checkbox" id="autoChk"> Auto-r√©partir apr√®s chaque changement</label>
      </div>
      <hr>
      <div style="font-weight:600">‚öôÔ∏è Objectifs</div>
      <div class="row">
        <div><label>Cible id√©ale (min)</label><input id="targetInput" type="number" min="10" step="5" value="75"></div>
        <div><label>Plafond max (min)</label><input id="maxInput" type="number" min="10" step="5" value="90"></div>
      </div>
      <hr>
      <div style="font-weight:600">‚ûï Ajouter une t√¢che</div>
      <div class="row">
        <div><label>Nom</label><input id="addName" placeholder="Ex. Nettoyer frigo"></div>
        <div><label>Dur√©e</label><input id="addDur" type="number" min="1" step="1" value="30"></div>
        <div><label>Fr√©quence (jours)</label><input id="addFreq" type="number" min="1" step="1" value="7"></div>
      </div>
      <button class="btn" id="addBtn">Ajouter</button>
      <hr>
      <div style="font-weight:600">‚úèÔ∏è Modifier une t√¢che</div>
      <div><label>Choisir</label><select id="editSel"></select></div>
      <div class="row">
        <div><label>Nom</label><input id="editName"></div>
        <div><label>Dur√©e</label><input id="editDur" type="number" min="1"></div>
        <div><label>Fr√©quence</label><input id="editFreq" type="number" min="1"></div>
      </div>
      <button class="btn" id="saveEdit">Enregistrer</button>
      <hr>
      <div style="font-weight:600">üóëÔ∏è Supprimer une t√¢che</div>
      <div><label>Choisir</label><select id="delSel"></select></div>
      <button class="btn" id="delBtn">Supprimer</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="panel" id="statsPanel">
    <div class="p-head">Statistiques</div>
    <div class="p-body">
      <div><label>P√©riode</label>
        <select id="statsFilter">
          <option value="month">Ce mois</option>
          <option value="year">Cette ann√©e</option>
        </select>
      </div>
      <div class="chart"><canvas id="pie"></canvas></div>
      <div class="chart"><canvas id="bars"></canvas></div>
    </div>
  </div>

<script>
/* ========= GOOGLE CALENDAR CONFIG ========= */
const CLIENT_ID = "691551955911-i6mhvllgop4f1u5q2k144tmqvt6q2pei.apps.googleusercontent.com";
const API_KEY   = ""; // tu peux laisser vide si tu n‚Äôen as pas besoin
const SCOPES    = "https://www.googleapis.com/auth/calendar.readonly";

let GoogleAuth;
let events = []; // √©v√©nements r√©cup√©r√©s

function initClient() {
  gapi.client.init({
    apiKey: API_KEY,
    clientId: CLIENT_ID,
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
    scope: SCOPES,
  }).then(() => {
    GoogleAuth = gapi.auth2.getAuthInstance();
    if (!GoogleAuth.isSignedIn.get()) {
      GoogleAuth.signIn();
    } else {
      listEvents();
    }
  });
}

function listEvents() {
  gapi.client.calendar.events.list({
    calendarId: "primary",   // Ton agenda principal
    timeMin: new Date().toISOString(),
    showDeleted: false,
    singleEvents: true,
    maxResults: 50,
    orderBy: "startTime"
  }).then(response => {
    events = response.result.items || [];
    renderWeek(); // apr√®s avoir les events on redessine
  });
}

gapi.load("client:auth2", initClient);

/* ========= Utils dates ========= */
const fmtISO = d => { d=new Date(d); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); };
const todayISO = () => fmtISO(new Date());
const addDays = (iso, n) => { const d=new Date(iso); d.setDate(d.getDate()+n); return fmtISO(d); };
const mondayOf = (weeksFromNow=0) => { const d=new Date(); let wd=d.getDay(); if(wd===0) wd=7; d.setDate(d.getDate()-wd+1 + weeksFromNow*7); return fmtISO(d); };
const frDay = d => new Date(d).toLocaleDateString('fr-FR',{weekday:'long'});
const frDate = d => new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'long'});
function getWeekNumber(d){
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
const isWeekend = iso => { const wd = new Date(iso).getDay(); return wd===0 || wd===6; };

/* ========= Tes donn√©es / t√¢ches locales ========= */
const TASKS_KEY='tasks_v5';
const ABS_KEY='absences_v5';
let tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
let absences = JSON.parse(localStorage.getItem(ABS_KEY) || '[]'); 

/* ========= Rendu semaine ========= */
function renderWeek(){
  const weekView = document.getElementById('weekView');
  weekView.innerHTML = '';
  const mondayISO = mondayOf(0);
  const monday = new Date(mondayISO);

  for(let i=0;i<7;i++){
    const dISO = fmtISO(new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+i));
    const day = document.createElement('div');
    day.className = 'day';

    const head = document.createElement('div');
    head.className = 'day-head';
    head.innerHTML = `<div class="weekday">${frDay(dISO)}</div>
                      <div class="date">${frDate(dISO)}</div>`;
    day.appendChild(head);

    // === T√¢ches locales ===
    tasks.forEach(t=>{
      if(t.nextDue===dISO){
        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.innerHTML = `<span>${t.name}</span><span class="badge">${t.duration}m</span>`;
        day.appendChild(pill);
      }
    });

    // === Events Google Calendar ===
    events.forEach(ev=>{
      let start = ev.start.date || ev.start.dateTime;
      if(start){
        const evISO = fmtISO(start);
        if(evISO === dISO){
          const pill = document.createElement('div');
          pill.className = 'pill marine'; // couleur Marine par ex
          pill.innerHTML = `<span>${ev.summary}</span>`;
          day.appendChild(pill);
        }
      }
    });

    weekView.appendChild(day);
  }
}

/* ========= Init ========= */
(function init(){
  renderWeek(); // affichage vide si pas encore connect√©
})();
</script>

</body>
</html>
