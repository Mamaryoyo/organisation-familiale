<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Organisation familiale — vMax (GIS + jauge + filtres Y/M) — Partie 1/2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Chart.js (chargé async dans la partie 2) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" async></script>
<!-- Google Identity Services (auth) + gapi client (Calendar API) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<style>
  /*****************************************************************************************************************
   * THEME & TOKENS
   * ----------------------------------------------------------------------------------------------------------------
   * Palette + tokens utilisés partout. Les variables sont sur :root et swap avec .dark.
   * Ajout de variables pour états, fonds, etc.
   *****************************************************************************************************************/
  :root{
    --bg:#f6f7f9; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
    --blue:#2563eb; --yellow:#facc15; --green:#22c55e; --orange:#f59e0b; --red:#ef4444;
    --indigo:#6366f1; --teal:#14b8a6; --pink:#ec4899;
    --red-soft:#fee2e2; --red-soft-dark:rgba(239,68,68,.15);
    --card:#ffffff; --card-soft:#f3f4f6; --shadow:0 1px 3px rgba(0,0,0,.08);
    --ring: 0 0 0 2px rgba(37,99,235,.35);
    --focus-ring: 0 0 0 3px rgba(99,102,241,.4);
    --success-ring: 0 0 0 3px rgba(34,197,94,.35);
    --warning-ring: 0 0 0 3px rgba(245,158,11,.35);
  }
  body.dark{
    --bg:#1f1f23; --panel:#2b2b31; --text:#e5e5e5; --muted:#9ca3af; --line:#3b3b45;
    --card:#2b2b31; --card-soft:#3a3a42; --shadow:0 1px 3px rgba(0,0,0,.35);
    --ring: 0 0 0 2px rgba(99,102,241,.45);
  }

  /*****************************************************************************************************************
   * BASE
   *****************************************************************************************************************/
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Helvetica Neue",Arial,sans-serif;
    background:var(--bg); color:var(--text); display:flex; height:100vh; overflow:hidden;
    transition:background .3s,color .3s;
  }
  button{font:inherit}
  button:focus{outline:none; box-shadow:var(--ring);} /* Ring accessible */
  a{color:inherit; text-decoration:none}

  /* Utilitaires */
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .visually-hidden{clip:rect(0 0 0 0);clip-path:inset(50%);height:1px;overflow:hidden;position:absolute;white-space:nowrap;width:1px}

  /*****************************************************************************************************************
   * LAYOUT
   *****************************************************************************************************************/
  .app{display:flex; flex:1; width:100%; height:100%;}
  .left{flex:2; display:flex; flex-direction:column; border-right:1px solid var(--line); min-width:640px;}
  .right{flex:1; display:flex; flex-direction:column; min-width:360px;}

  /* Top bar */
  .bar{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5}
  .title{font-weight:600; font-size:18px}
  .sub{font-size:13px; color:var(--muted)}
  .bar-left{display:flex; flex-direction:column; gap:2px}
  .bar-right{display:flex; align-items:center; gap:8px}
  .btn{background:var(--panel); border:1px solid var(--line); padding:6px 10px; border-radius:8px; cursor:pointer; box-shadow:var(--shadow); color:var(--text)}
  .btn:hover{filter:brightness(0.98)}
  .btn.active{box-shadow:0 0 0 2px rgba(37,99,235,.25) inset; font-weight:600}
  .icon{background:var(--panel); border:1px solid var(--line); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:18px; line-height:1; box-shadow:var(--shadow); color:var(--text)}

  /*****************************************************************************************************************
   * WEEK VIEW — hauteur fixe + jauges par colonne
   *****************************************************************************************************************/
  .week-wrap{flex:none; height:640px; overflow:auto; background:var(--panel)}
  .week-view{display:flex; gap:8px; padding:12px; transform:translateX(0); transition:transform .35s ease; height:100%}
  .day{flex:1; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; display:flex; flex-direction:column; align-items:stretch; box-shadow:var(--shadow); min-width:0; height:100%}
  .day-head{display:flex; flex-direction:column; align-items:center; margin-bottom:8px}
  .weekday{font-size:16px; font-weight:500; text-transform:capitalize}
  .date{font-size:12px; color:var(--muted)}
  .today-ring{border:2px solid var(--blue); border-radius:10px; padding:2px 6px}
  .pill{margin-top:6px; background:var(--panel); border-radius:10px; padding:8px; font-size:12px; border-left:6px solid #ccc; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; gap:8px}
  .pill .badge{font-size:11px; padding:2px 6px; border-radius:999px; background:#e5e7eb; color:#111}
  body.dark .pill .badge{background:#444; color:#eee}
  .pill.yonice{border-left-color:var(--blue)}
  .pill.marine{border-left-color:var(--yellow)}
  .pill.event{border-left-color:var(--green)}
  .absent{background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.08)); outline:1px dashed rgba(239,68,68,.6);}  
  .day-foot{margin-top:auto; display:flex; flex-direction:column; align-items:center; gap:6px; padding-top:8px}
  .load-chip{font-size:11px; color:var(--muted); background:var(--card-soft); border:1px solid var(--line); border-radius:999px; padding:2px 8px}
  .load-bar{height:8px; width:86%; border-radius:999px; background:var(--line); overflow:hidden; position:relative}
  .load-fill{height:100%; border-radius:999px; width:0}
  .tick{position:absolute; top:50%; transform:translateY(-50%); width:2px; height:8px; background:var(--muted); opacity:.35}

  /*****************************************************************************************************************
   * MONTH (absences) — repliable sous la semaine
   *****************************************************************************************************************/
  .month{background:var(--panel); border-top:1px solid var(--line); padding:10px 12px; display:none}
  .month-top{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:6px}
  .month-title{font-weight:600; flex:1; text-align:center}
  .days-head{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:6px; color:var(--muted); font-size:11px; text-align:center}
  .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .cell{width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; user-select:none; background:transparent; border:1px solid var(--line); color:var(--text); transition:transform .08s ease, background .2s ease, border-color .2s ease}
  .cell:hover{transform:scale(1.04)}
  .cell.today{box-shadow:0 0 0 2px var(--blue) inset; border-color:var(--blue); font-weight:700}
  .cell.wknd{background:var(--card-soft); color:var(--muted)}
  .cell.abs{background:var(--red); color:#fff; border-color:var(--red)}

  /*****************************************************************************************************************
   * RIGHT — 9 prochaines tâches
   *****************************************************************************************************************/
  .right-head{padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line)}
  .tasks{flex:1; padding:12px; display:grid; grid-template-columns:repeat(3,1fr); gap:10px; overflow:auto}
  .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; text-align:center; box-shadow:var(--shadow); cursor:pointer; transition:transform .12s ease, opacity .25s ease}
  .card:hover{transform:translateY(-1px)}
  .card.fade{opacity:0; transform:scale(.9)}
  .name{font-weight:600; font-size:14px; margin:0; display:flex; align-items:center; gap:8px; justify-content:center}
  .meta{font-size:12px; color:var(--muted); margin-top:4px}
  .days{font-weight:800; font-size:26px; margin-top:6px}
  .upcoming{background:var(--card-soft)}
  body.dark .upcoming{background:var(--card)}
  .late{background:var(--red-soft); border-color:var(--red)}
  body.dark .late{background:var(--red-soft-dark); border-color:var(--red); color:#fca5a5}

  /*****************************************************************************************************************
   * MODAL (validation qui)
   *****************************************************************************************************************/
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); backdrop-filter:blur(6px); z-index:20}
  .dialog{background:var(--panel); color:var(--text); padding:18px; border-radius:12px; width:min(420px,92vw); box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .dialog h3{margin:0 0 12px 0; font-size:16px; font-weight:600; text-align:center}
  .who{display:flex; gap:10px}
  .wbtn{flex:1; padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:700}
  .wbtn.yonice{background:var(--blue); color:#fff}
  .wbtn.marine{background:var(--yellow); color:#333}

  /*****************************************************************************************************************
   * PANELS (paramètres & stats)
   *****************************************************************************************************************/
  .panel{position:fixed; top:0; right:-460px; width:460px; height:100%; background:var(--panel); border-left:1px solid var(--line); box-shadow:-4px 0 12px rgba(0,0,0,.12); transition:right .28s ease; z-index:25; display:flex; flex-direction:column}
  .panel.open{right:0}
  .p-head{padding:14px; border-bottom:1px solid var(--line); font-weight:700}
  .p-body{padding:14px; overflow:auto; display:flex; flex-direction:column; gap:12px}
  label{font-size:12px; color:var(--muted)}
  input,select{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:var(--card); color:var(--text)}
  hr{border:none; border-top:1px solid var(--line); margin:6px 0}
  .row{display:flex; gap:8px}
  .row > *{flex:1}
  .chart{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:var(--shadow)}

  /*****************************************************************************************************************
   * RESPONSIVE + gestion panneau d'absences
   *****************************************************************************************************************/
  @media (max-width:1200px){ .left{min-width:520px} }
  @media (max-width:980px){ .left{min-width:0} .right{min-width:0} .tasks{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:720px){ .app{flex-direction:column} .tasks{grid-template-columns:1fr} }

  /* Réduction automatique de la semaine quand le panneau d'absences est ouvert */
  .left.abs-open .week-wrap{height:360px}
  .left.abs-open .month{display:block}

  /* Pastille Y/M (qui a fait en dernier) */
  .who-badge{display:inline-flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; width:18px; height:18px; border-radius:999px; margin-left:auto; border:1px solid var(--line)}
  .who-badge.y{background:rgba(37,99,235,.12); color:#1e3a8a}
  .who-badge.m{background:rgba(250,204,21,.25); color:#854d0e}

  /*****************************************************************************************************************
   * Impression (optionnel)
   *****************************************************************************************************************/
  @media print{
    body{background:#fff}
    .panel, .modal, .right-head, #settingsBtn, #statsBtn, #absenceBtn{display:none!important}
    .left{min-width:0!important}
    .week-wrap{height:auto!important; overflow:visible}
  }
</style>
</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <div class="left">
      <div class="bar">
        <div class="bar-left">
          <div class="title" id="weekTitle">Semaine</div>
          <div class="sub" id="weekSub"></div>
        </div>
        <div class="bar-right">
          <button class="btn" id="prevW" title="Semaine précédente" aria-label="Semaine précédente">‹</button>
          <button class="btn" id="todayBtn" title="Revenir à aujourd’hui" aria-label="Aujourd’hui">Aujourd’hui</button>
          <button class="btn" id="nextW" title="Semaine suivante" aria-label="Semaine suivante">›</button>
          <button class="btn" id="autoBtn" title="Répartir la semaine" aria-label="Répartition auto">↔️</button>
          <!-- Filtres Y/M rapides -->
          <div class="who-filter" style="display:flex;gap:6px;margin-left:6px">
            <button class="btn" id="whoAll" title="Toutes les tâches">All</button>
            <button class="btn" id="whoY" title="Tâches de Yonice">Y</button>
            <button class="btn" id="whoM" title="Tâches de Marine">M</button>
          </div>
          <button class="icon" id="absenceBtn" title="Absences" aria-label="Absences">💼</button>
          <button class="icon" id="statsBtn" title="Statistiques" aria-label="Statistiques">📈</button>
          <button class="icon" id="settingsBtn" title="Paramètres" aria-label="Paramètres">⚙️</button>
        </div>
      </div>

      <div class="week-wrap">
        <div class="week-view" id="weekView"></div>
      </div>

      <!-- Panneau absences (repliable) -->
      <div class="month" id="absencePanel">
        <div class="month-top">
          <button class="btn" id="prevM" title="Mois précédent">‹</button>
          <div class="month-title" id="monthTitle">Mois</div>
          <button class="btn" id="nextM" title="Mois suivant">›</button>
          <button class="btn" id="closeAbs" title="Fermer">✖</button>
        </div>
        <div class="days-head"><div>lu</div><div>ma</div><div>me</div><div>je</div><div>ve</div><div>sa</div><div>di</div></div>
        <div class="grid" id="monthGrid"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="right-head">
        <div class="title" style="font-size:16px">9 prochaines tâches</div>
        <div class="sub">Appuie pour valider (popup Yonice / Marine)</div>
      </div>
      <div class="tasks" id="tasksGrid"></div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTaskName">
    <div class="dialog">
      <h3 id="modalTaskName">Qui a fait… ?</h3>
      <div class="who">
        <button class="wbtn yonice" id="whoYonice">Yonice</button>
        <button class="wbtn marine" id="whoMarine">Marine</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="panel" id="settingsPanel" aria-label="Panneau paramètres">
    <div class="p-head">Paramètres</div>
    <div class="p-body">
      <div class="row">
        <button class="btn" id="themeToggle">Basculer clair / sombre</button>
        <label style="display:flex; align-items:center; gap:8px"><input type="checkbox" id="autoChk"> Auto-répartir après chaque changement</label>
      </div>
      <hr>
      <div style="font-weight:600">⚙️ Objectifs</div>
      <div class="row">
        <div><label>Cible idéale (min)</label><input id="targetInput" type="number" min="10" step="5" value="75"></div>
        <div><label>Plafond max (min)</label><input id="maxInput" type="number" min="10" step="5" value="90"></div>
      </div>
      <div class="row">
        <div><label>Inclure événements Google dans la charge</label>
          <select id="eventsWeight">
            <option value="0">Ignorer (0 min)</option>
            <option value="dur">Durée réelle (si dispo)</option>
            <option value="30">Forfait 30 min</option>
            <option value="60">Forfait 60 min</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Masquer les week-ends</label>
          <select id="hideWeekends">
            <option value="no">Afficher</option>
            <option value="yes">Masquer</option>
          </select>
        </div>
        <div><label>Rappels clavier (A/Y/M/T)</label>
          <select id="kbdHints">
            <option value="on">Activer</option>
            <option value="off">Désactiver</option>
          </select>
        </div>
      </div>
      <hr>
      <div style="font-weight:600">➕ Ajouter une tâche</div>
      <div class="row">
        <div><label>Nom</label><input id="addName" placeholder="Ex. Nettoyer frigo"></div>
        <div><label>Durée (min)</label><input id="addDur" type="number" min="1" step="1" value="30"></div>
        <div><label>Fréquence (jours)</label><input id="addFreq" type="number" min="1" step="1" value="7"></div>
      </div>
      <button class="btn" id="addBtn">Ajouter</button>
      <hr>
      <div style="font-weight:600">✏️ Modifier une tâche</div>
      <div><label>Choisir</label><select id="editSel"></select></div>
      <div class="row">
        <div><label>Nom</label><input id="editName"></div>
        <div><label>Durée</label><input id="editDur" type="number" min="1"></div>
        <div><label>Fréquence</label><input id="editFreq" type="number" min="1"></div>
      </div>
      <button class="btn" id="saveEdit">Enregistrer</button>
      <hr>
      <div style="font-weight:600">🗑️ Supprimer une tâche</div>
      <div><label>Choisir</label><select id="delSel"></select></div>
      <button class="btn" id="delBtn">Supprimer</button>
      <hr>
      <div style="font-weight:600">🧹 Données</div>
      <div class="row">
        <button class="btn" id="exportBtn">Exporter JSON</button>
        <button class="btn" id="importBtn">Importer JSON</button>
        <button class="btn" id="clearBtn">Réinitialiser</button>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="panel" id="statsPanel" aria-label="Panneau statistiques">
    <div class="p-head">Statistiques</div>
    <div class="p-body">
      <div><label>Période</label>
        <select id="statsFilter">
          <option value="month">Ce mois</option>
          <option value="year">Cette année</option>
        </select>
      </div>
      <div class="chart"><canvas id="pie"></canvas></div>
      <div class="chart"><canvas id="bars"></canvas></div>
      <div class="chart"><canvas id="daily"></canvas></div>
    </div>
  </div>

  <!--
    ==========================
    =  SCRIPT — PARTIE 1/2  =
    ==========================
    NOTE: Cette partie contient toute la configuration, les utilitaires, l'état, et une portion des fonctions.
    La partie 2/2 continue le script et referme la page HTML.
  -->
<script>
/***************************************************
 * CONFIG — Google API (Calendar) via GIS
 ***************************************************/
const CLIENT_ID = "691551955911-i6mhvllgop4f1u5q2k144tmqvt6q2pei.apps.googleusercontent.com";
const SCOPES    = "https://www.googleapis.com/auth/calendar.readonly";
let tokenClient; // GIS token client
let gapiInited = false; let gisInited = false;
let events = []; // Google Calendar events

// Chargement du client gapi + demande de token via GIS
window.addEventListener('load', () => {
  if (window.gapi){
    gapi.load('client', async () => {
      await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
      gapiInited = true; maybeEnable();
    });
  }
  const iv = setInterval(() => {
    if (window.google && window.google.accounts && window.google.accounts.oauth2){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if (resp && resp.access_token){
            gapi.client.setToken({access_token: resp.access_token});
            await listEvents();
          }
        }
      });
      gisInited = true; maybeEnable();
      clearInterval(iv);
    }
  }, 60);
});

function maybeEnable(){ if (gapiInited && gisInited){ tokenClient.requestAccessToken({ prompt:'consent' }); } }

async function listEvents(){
  try{
    const resp = await gapi.client.calendar.events.list({
      calendarId: 'primary',
      timeMin: new Date().toISOString(),
      showDeleted: false,
      singleEvents: true,
      maxResults: 100,
      orderBy: 'startTime'
    });
    events = resp.result.items || [];
    renderAll();
  }catch(e){ console.warn('Erreur events', e); }
}

/***************************************************
 * STORAGE & DATA
 ***************************************************/
const TASKS_KEY='tasks_v8';
const ABS_KEY='absences_v8';
const LOGS_KEY='logs_v8';
const PREF_KEY='prefs_v8';

let tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
let absences = JSON.parse(localStorage.getItem(ABS_KEY) || '[]'); // ["YYYY-MM-DD", ...]
let logs = JSON.parse(localStorage.getItem(LOGS_KEY) || '[]'); // {date, taskId, who, duration}
let prefs = JSON.parse(localStorage.getItem(PREF_KEY) || '{}');

function saveAll(){
  localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
  localStorage.setItem(ABS_KEY, JSON.stringify(absences));
  localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
  localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
}

/***************************************************
 * DATE UTILS (local + ISO jour)
 ***************************************************/
const pad = n => String(n).padStart(2,'0');
const toISODateLocal = (d)=>{ const x = new Date(d); const y = new Date(x.getFullYear(), x.getMonth(), x.getDate()); return `${y.getFullYear()}-${pad(y.getMonth()+1)}-${pad(y.getDate())}`; };
const todayISO = () => toISODateLocal(new Date());
const addDaysISO = (iso, n)=>{ const [Y,M,D] = iso.split('-').map(Number); return toISODateLocal(new Date(Y, M-1, D + n)); };
const mondayOf = (weekOffset=0) => { const now = new Date(); const wd = (now.getDay()||7); const monday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - wd + 1 + weekOffset*7); return toISODateLocal(monday); };
const frDay = d => new Date(d).toLocaleDateString('fr-FR',{weekday:'long'});
const frDate = d => new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'long'});
function getWeekNumber(d){ d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }
const isWeekend = iso => { const wd = new Date(iso).getDay(); return wd===0 || wd===6; };

/***************************************************
 * HELPERS
 ***************************************************/
function uid(){ return Math.random().toString(36).slice(2,10); }
function groupByDate(items, getDateStr){ const map = new Map(); for(const it of items){ const k = getDateStr(it); if(!map.has(k)) map.set(k, []); map.get(k).push(it);} return map; }
function minutesBetween(start, end){ const s = new Date(start).getTime(); const e = new Date(end).getTime(); if(!isFinite(s)||!isFinite(e)|| e<=s) return 0; return Math.round((e-s)/60000); }

/***************************************************
 * WHO FILTER — état global + helpers UI
 ***************************************************/
let whoFilter = 'all';
function applyWhoFilterUI(){
  const a=document.getElementById('whoAll'); const y=document.getElementById('whoY'); const m=document.getElementById('whoM');
  if(!a||!y||!m) return;
  a.classList.toggle('active', whoFilter==='all');
  y.classList.toggle('active', whoFilter==='y');
  m.classList.toggle('active', whoFilter==='m');
}
function setWhoFilter(f){
  whoFilter = f; prefs.whoFilter=f; saveAll();
  applyWhoFilterUI();
  renderWeek();
  rebuildUpcoming();
}

/***************************************************
 * UI BUILDERS (pills, etc.)
 ***************************************************/
function makePill(text, classes=[], badgeText, who){
  const d = document.createElement('div'); d.className = 'pill ' + classes.join(' ');
  const left = document.createElement('span'); left.textContent = text; d.appendChild(left);
  if(badgeText!==undefined){ const b = document.createElement('span'); b.className='badge'; b.textContent = badgeText; d.appendChild(b); }
  if(who){ const wb = document.createElement('span'); wb.className = 'who-badge ' + (who==='Yonice'?'y':'m'); wb.textContent = who==='Yonice'?'Y':'M'; d.appendChild(wb); }
  return d;
}

/***************************************************
 * ÉTAT DERNIER QUI (lastWhoMap) — construit depuis logs
 ***************************************************/
let lastWhoMap = new Map();
function rebuildLastWhoMap(){
  lastWhoMap = new Map();
  for(let i=logs.length-1;i>=0;i--){
    const l = logs[i];
    if(!lastWhoMap.has(l.taskId)) lastWhoMap.set(l.taskId, l.who);
  }
}

/***************************************************
 * RENDER ALL — appele les sous-rendus
 ***************************************************/
function renderAll(){
  tasks.forEach(recomputeNextDue);
  rebuildLastWhoMap();
  saveAll();
  renderWeek();
  rebuildUpcoming();
}

/***************************************************
 * PLACEHOLDERS (les fonctions continuent dans la partie 2)
 ***************************************************/
function renderWeek(){ /* défini dans PARTIE 2 */ }
function rebuildUpcoming(){ /* défini dans PARTIE 2 */ }
function openModal(taskIndex){ /* défini dans PARTIE 2 */ }
function renderMonth(){ /* défini dans PARTIE 2 */ }
function renderStats(){ /* défini dans PARTIE 2 */ }
function distributeWeek(){ /* défini dans PARTIE 2 */ }
function refreshSelectors(){ /* défini dans PARTIE 2 */ }
function recomputeNextDue(task){ if(!task.nextDue){ task.nextDue = todayISO(); } }
function exportJSON(){ /* défini dans PARTIE 2 */ }
function importJSON(){ /* défini dans PARTIE 2 */ }
function clearAll(){ /* défini dans PARTIE 2 */ }

/***************************************************
 * INIT UI + EVENTS (partiellement ici, fin en PARTIE 2)
 ***************************************************/
function initUI(){
  // Thème
  if(prefs.theme==='dark') document.body.classList.add('dark');

  // Restauration préférences
  if(prefs.target) document.getElementById('targetInput').value = prefs.target;
  if(prefs.maxCap) document.getElementById('maxInput').value = prefs.maxCap;
  if(prefs.eventsWeight) document.getElementById('eventsWeight').value = prefs.eventsWeight;
  if(prefs.hideWeekends) document.getElementById('hideWeekends').value = prefs.hideWeekends;
  if(prefs.kbdHints) document.getElementById('kbdHints').value = prefs.kbdHints;
  if(prefs.auto) document.getElementById('autoChk').checked = !!prefs.auto;
  whoFilter = prefs.whoFilter || 'all';
  applyWhoFilterUI();

  // Nav semaine
  document.getElementById('todayBtn').addEventListener('click', ()=>{ weekOffset=0; renderWeek(); });
  document.getElementById('prevW').addEventListener('click', ()=>{ weekOffset--; saveWeekOffset(); renderWeek(); });
  document.getElementById('nextW').addEventListener('click', ()=>{ weekOffset++; saveWeekOffset(); renderWeek(); });

  // Panneaux
  const settingsPanel = document.getElementById('settingsPanel');
  document.getElementById('settingsBtn').addEventListener('click', ()=> settingsPanel.classList.toggle('open'));
  document.getElementById('themeToggle').addEventListener('click', ()=> { document.body.classList.toggle('dark'); prefs.theme = document.body.classList.contains('dark')? 'dark':'light'; saveAll(); });

  const statsPanel = document.getElementById('statsPanel');
  document.getElementById('statsBtn').addEventListener('click', ()=> { statsPanel.classList.toggle('open'); renderStats(); });
  document.getElementById('statsFilter').addEventListener('change', renderStats);

  // Absences : les handlers précis sont ajoutés en PARTIE 2 pour garder la continuité de code

  // WHO Filter boutons
  document.getElementById('whoAll').addEventListener('click', ()=> setWhoFilter('all'));
  document.getElementById('whoY').addEventListener('click', ()=> setWhoFilter('y'));
  document.getElementById('whoM').addEventListener('click', ()=> setWhoFilter('m'));

  // Objectifs / prefs live
  document.getElementById('targetInput').addEventListener('input', ()=>{ prefs.target = Number(document.getElementById('targetInput').value)||75; saveAll(); renderWeek(); });
  document.getElementById('maxInput').addEventListener('input', ()=>{ prefs.maxCap = Number(document.getElementById('maxInput').value)||90; saveAll(); renderWeek(); });
  document.getElementById('eventsWeight').addEventListener('change', ()=>{ prefs.eventsWeight = document.getElementById('eventsWeight').value; saveAll(); renderWeek(); });
  document.getElementById('hideWeekends').addEventListener('change', ()=>{ prefs.hideWeekends = document.getElementById('hideWeekends').value; saveAll(); renderWeek(); });
  document.getElementById('kbdHints').addEventListener('change', ()=>{ prefs.kbdHints = document.getElementById('kbdHints').value; saveAll(); });
  document.getElementById('autoChk').addEventListener('change', (e)=>{ prefs.auto = e.target.checked; saveAll(); });

  // Données
  document.getElementById('exportBtn').addEventListener('click', exportJSON);
  document.getElementById('importBtn').addEventListener('click', importJSON);
  document.getElementById('clearBtn').addEventListener('click', clearAll);

  refreshSelectors();
}

/***************************************************
 * PERSISTENCE DE LA POSITION SEMAINE
 ***************************************************/
let weekOffset = Number(localStorage.getItem('weekOffset')||0) || 0;
function saveWeekOffset(){ localStorage.setItem('weekOffset', String(weekOffset)); }

/***************************************************
 * BOOT (partagé)
 ***************************************************/
(function boot(){
  // Données de démonstration si vide
  if(tasks.length===0){
    tasks = [
      { id: uid(), name:'Vaisselle', duration:30, freq:1, nextDue: todayISO() },
      { id: uid(), name:'Lessive', duration:45, freq:3, nextDue: addDaysISO(todayISO(),1) },
      { id: uid(), name:'Courses', duration:60, freq:7, nextDue: addDaysISO(todayISO(),2) },
      { id: uid(), name:'Aspirateur', duration:25, freq:4, nextDue: addDaysISO(todayISO(),1) },
      { id: uid(), name:'Salle de bain', duration:40, freq:7, nextDue: addDaysISO(todayISO(),3) },
      { id: uid(), name:'Poubelles', duration:15, freq:2, nextDue: todayISO() },
      { id: uid(), name:'Cuisine', duration:35, freq:5, nextDue: addDaysISO(todayISO(),4) },
      { id: uid(), name:'Arrosage plantes', duration:20, freq:3, nextDue: addDaysISO(todayISO(),5) },
      { id: uid(), name:'Litière', duration:15, freq:3, nextDue: addDaysISO(todayISO(),6) }
    ];
  }
  initUI();
  renderAll(); // les events arrivent après GIS token
})();
</script>
<!--
  ===== FIN PARTIE 1/2 =====
  Ouvre maintenant la PARTIE 2/2 et colle-la à la suite de ce fichier pour exécuter en local.
-->
<!--
  ==========================
  =  SCRIPT — PARTIE 2/2  =
  ==========================
  Cette partie complète le script en définissant toutes les fonctions laissées en placeholders dans la PARTIE 1/2.
  Pour exécuter la page dans le canvas, vous pouvez aussi copier/coller les deux parties dans un même fichier.
-->
<script>
/***************************************************
 * RENDER SEMAINE — hauteur fixe + jauges + filtre Y/M
 ***************************************************/
function renderWeek(){
  const weekView = document.getElementById('weekView');
  weekView.innerHTML = '';

  const mondayISO_ = mondayOf(weekOffset);
  const monday = new Date(mondayISO_);
  const sunday = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+6);
  const wkNum = getWeekNumber(monday);
  document.getElementById('weekTitle').textContent = `Semaine ${wkNum}`;
  document.getElementById('weekSub').textContent = `${frDate(monday)} – ${frDate(sunday)}`;

  // Settings courants
  const target = Number(document.getElementById('targetInput').value)||75;
  const maxCap = Number(document.getElementById('maxInput').value)||90;
  const eventsWeight = document.getElementById('eventsWeight').value; // '0' | 'dur' | '30' | '60'
  const hideWeekends = (document.getElementById('hideWeekends').value||'no') === 'yes';

  // Index
  const evByDate = groupByDate(events, ev => toISODateLocal(ev.start?.date || ev.start?.dateTime));
  const tasksByDate = groupByDate(tasks.filter(t=>t.nextDue), t => t.nextDue);

  const frag = document.createDocumentFragment();
  for(let i=0;i<7;i++){
    const dISO = addDaysISO(mondayISO_, i);
    const wd = new Date(dISO).getDay(); // 0..6 (dim..sam)
    if(hideWeekends && (wd===0 || wd===6)) continue; // skip weekends

    const day = document.createElement('div'); day.className = 'day';
    if(absences.includes(dISO)) day.classList.add('absent');

    const head = document.createElement('div'); head.className = 'day-head';
    const wdEl = document.createElement('div'); wdEl.className='weekday'; wdEl.textContent = frDay(dISO);
    const dt = document.createElement('div'); dt.className='date'; dt.textContent = frDate(dISO);
    head.appendChild(wdEl); head.appendChild(dt); day.appendChild(head);

    let total = 0;

    // Tâches locales filtrées par whoFilter
    (tasksByDate.get(dISO)||[]).forEach(t=>{
      const lastWho = lastWhoMap.get(t.id) ?? lastWhoMap.get(tasks.indexOf(t)); // compat anciens logs
      if(whoFilter==='y' && lastWho!=='Yonice') return;
      if(whoFilter==='m' && lastWho!=='Marine') return;
      total += Number(t.duration)||0;
      const p = makePill(t.name, [], `${t.duration||0}m`, lastWho);
      day.appendChild(p);
    });

    // Événements Google Calendar — pondération configurable
    (evByDate.get(dISO)||[]).forEach(ev=>{
      const name = ev.summary || '(Sans titre)';
      let add = 0;
      if(eventsWeight==='dur' && ev.start && ev.end && ev.start.dateTime && ev.end.dateTime){ add = minutesBetween(ev.start.dateTime, ev.end.dateTime); }
      else if(eventsWeight==='30') add = 30; else if(eventsWeight==='60') add = 60; else add = 0;
      total += add;
      const p = makePill(name, ['event'], add? `${add}m` : undefined); day.appendChild(p);
    });

    // Pied : jauge
    const foot = document.createElement('div'); foot.className = 'day-foot';
    const chip = document.createElement('div'); chip.className='load-chip'; chip.textContent = `${total} / ${target} min`;
    const bar = document.createElement('div'); bar.className='load-bar';
    const fill = document.createElement('div'); fill.className='load-fill';

    const pct = target>0 ? Math.min(100, Math.round(total/target*100)) : 0;
    fill.style.width = pct + '%';

    const rs = getComputedStyle(document.documentElement);
    const color = total <= target ? rs.getPropertyValue('--green').trim() : (total <= maxCap ? rs.getPropertyValue('--orange').trim() : rs.getPropertyValue('--red').trim());
    fill.style.background = color;

    const tick = document.createElement('div'); tick.className='tick'; tick.style.left = (target>0? Math.min(100, (target/target*100)) : 100) + '%';

    bar.appendChild(fill); bar.appendChild(tick);
    foot.appendChild(chip); foot.appendChild(bar);
    day.appendChild(foot);

    frag.appendChild(day);
  }
  weekView.appendChild(frag);
}

/***************************************************
 * 9 PROCHAINES TÂCHES — filtre Y/M appliqué
 ***************************************************/
function rebuildUpcoming(){
  const grid = document.getElementById('tasksGrid');
  grid.innerHTML = '';
  const itemsAll = tasks.map((t, idx)=>({ ...t, _idx: idx }))
    .filter(t=>t.nextDue);

  const filtered = itemsAll.filter(t=>{
    const lw = lastWhoMap.get(t.id) ?? lastWhoMap.get(t._idx);
    if(whoFilter==='all') return true;
    if(whoFilter==='y') return lw==='Yonice';
    if(whoFilter==='m') return lw==='Marine';
    return true;
  })
  .sort((a,b)=> a.nextDue.localeCompare(b.nextDue))
  .slice(0,9);

  const frag = document.createDocumentFragment();
  const today = new Date(todayISO());
  filtered.forEach(t=>{
    const card = document.createElement('div');
    const delta = Math.floor((new Date(t.nextDue) - today)/86400000);
    card.className = 'card ' + (delta<0? 'late':'upcoming');
    card.tabIndex = 0;

    const name = document.createElement('div'); name.className='name';
    const spanName = document.createElement('span'); spanName.textContent = t.name; name.appendChild(spanName);
    const lw = lastWhoMap.get(t.id) ?? lastWhoMap.get(t._idx);
    if(lw){ const wb=document.createElement('span'); wb.className='who-badge '+(lw==='Yonice'?'y':'m'); wb.textContent = lw==='Yonice'?'Y':'M'; name.appendChild(wb); }
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `durée ${t.duration}m · tous ${t.freq} j`;
    const days = document.createElement('div'); days.className='days';
    days.textContent = delta<0? `${Math.abs(delta)} j de retard` : (delta===0? "aujourd'hui" : `J-${delta}`);

    card.appendChild(name); card.appendChild(meta); card.appendChild(days);
    card.addEventListener('click', ()=> openModal(t._idx));
    frag.appendChild(card);
  });
  grid.appendChild(frag);
}

/***************************************************
 * MODAL — validation et logging (compat index -> id)
 ***************************************************/
function openModal(taskIndex){
  const t = tasks[taskIndex];
  document.getElementById('modalTaskName').textContent = `Qui a fait: ${t.name} ?`;
  const modal = document.getElementById('modal');
  modal.style.display='flex';
  const close = ()=>{ modal.style.display='none'; };
  const validate = who =>{
    logs.push({date: todayISO(), taskId: t.id ?? taskIndex, who, duration: t.duration||0});
    const base = t.nextDue && new Date(t.nextDue) > new Date(todayISO()) ? t.nextDue : todayISO();
    t.nextDue = addDaysISO(base, t.freq||7);
    saveAll();
    close();
    if(document.getElementById('autoChk').checked){ distributeWeek(); }
    renderAll();
  };
  document.getElementById('whoYonice').onclick = ()=> validate('Yonice');
  document.getElementById('whoMarine').onclick = ()=> validate('Marine');
  modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); }, { once:true });
}

/***************************************************
 * ABSENCES — calendrier mensuel et toggle hauteur
 ***************************************************/
let monthCursor = toISODateLocal(new Date());
function renderMonth(){
  const [Y,M] = monthCursor.split('-').map(Number);
  const first = new Date(Y, M-1, 1);
  const firstWeekday = (first.getDay()||7);
  const daysInMonth = new Date(Y, M, 0).getDate();
  const grid = document.getElementById('monthGrid');
  grid.innerHTML = '';
  document.getElementById('monthTitle').textContent = first.toLocaleDateString('fr-FR', {month:'long', year:'numeric'});

  for(let b=1; b<firstWeekday; b++){ const ph = document.createElement('div'); grid.appendChild(ph); }
  for(let d=1; d<=daysInMonth; d++){
    const iso = toISODateLocal(new Date(Y, M-1, d));
    const cell = document.createElement('div');
    cell.className = 'cell' + (isWeekend(iso)? ' wknd':'');
    if(iso===todayISO()) cell.classList.add('today');
    if(absences.includes(iso)) cell.classList.add('abs');
    cell.textContent = d;
    cell.addEventListener('click', ()=>{
      const idx = absences.indexOf(iso);
      if(idx>=0) absences.splice(idx,1); else absences.push(iso);
      saveAll(); renderMonth(); renderWeek();
    });
    grid.appendChild(cell);
  }
}

// Toggle open/close
(function wireAbsences(){
  const absPanel = document.getElementById('absencePanel');
  document.getElementById('absenceBtn').addEventListener('click', ()=>{
    const left = document.querySelector('.left');
    absPanel.style.display='block';
    left.classList.add('abs-open');
    renderMonth();
  });
  document.getElementById('closeAbs').addEventListener('click', ()=>{
    const left = document.querySelector('.left');
    absPanel.style.display='none';
    left.classList.remove('abs-open');
    renderWeek();
  });
  document.getElementById('prevM').addEventListener('click', ()=>{ const d=new Date(monthCursor); d.setMonth(d.getMonth()-1); monthCursor=toISODateLocal(d); renderMonth(); });
  document.getElementById('nextM').addEventListener('click', ()=>{ const d=new Date(monthCursor); d.setMonth(d.getMonth()+1); monthCursor=toISODateLocal(d); renderMonth(); });
})();

/***************************************************
 * STATS — Chart.js (camembert + barres + courbe)
 ***************************************************/
let pieChart, barChart, dailyChart;
function renderStats(){
  const period = document.getElementById('statsFilter').value; // 'month' | 'year'
  const now = new Date();
  const start = period==='month' ? new Date(now.getFullYear(), now.getMonth(), 1) : new Date(now.getFullYear(), 0, 1);
  const startISO = toISODateLocal(start);
  const filt = logs.filter(l => l.date >= startISO);

  const sumByWho = { Yonice:0, Marine:0 };
  const byDay = {};
  for(const l of filt){ sumByWho[l.who] = (sumByWho[l.who]||0) + (l.duration||0); byDay[l.date] = (byDay[l.date]||0) + (l.duration||0); }

  const pctx = document.getElementById('pie'); if (pieChart) pieChart.destroy();
  pieChart = new Chart(pctx, { type:'pie', data:{ labels:Object.keys(sumByWho), datasets:[{ data:Object.values(sumByWho) }] }, options:{ responsive:true } });

  const labels = []; const data = [];
  for(let i=6;i>=0;i--){ const iso = addDaysISO(todayISO(), -i); labels.push(new Date(iso).toLocaleDateString('fr-FR',{weekday:'short'})); data.push(byDay[iso]||0); }
  const bctx = document.getElementById('bars'); if (barChart) barChart.destroy();
  barChart = new Chart(bctx, { type:'bar', data:{ labels, datasets:[{ label:'Durée (min)', data }] }, options:{ responsive:true } });

  const labels2 = []; const data2 = [];
  for(let i=13;i>=0;i--){ const iso = addDaysISO(todayISO(), -i); labels2.push(iso.slice(5)); let s=0; const dTasks = tasks.filter(t=>t.nextDue===iso); dTasks.forEach(t=> s+= Number(t.duration)||0); data2.push(s); }
  const dctx = document.getElementById('daily'); if (dailyChart) dailyChart.destroy();
  dailyChart = new Chart(dctx, { type:'line', data:{ labels:labels2, datasets:[{ label:'Charge tâches (min)', data:data2, tension:.3 }] }, options:{ responsive:true } });
}

/***************************************************
 * DISTRIBUTION — heuristique vers cible (cap max respecté)
 ***************************************************/
function distributeWeek(){
  const target = Number(document.getElementById('targetInput').value)||75;
  const maxCap = Number(document.getElementById('maxInput').value)||90;
  const mondayISO_ = mondayOf(weekOffset);
  const hideWeekendsPref = (document.getElementById('hideWeekends').value||'no')==='yes';

  // All 7 days of the displayed week
  const days = Array.from({length:7}, (_,i)=> addDaysISO(mondayISO_, i));
  // Days we are allowed to schedule tasks on
  const availableDays = days.filter(d => !absences.includes(d) && (!hideWeekendsPref || !isWeekend(d)));

  // Build current loads for available days only
  const dayLoad = new Map(availableDays.map(d=>[d,0]));
  const inWeekTasks = tasks.filter(t=> days.includes(t.nextDue));

  // Pre-fill loads and mark tasks on unavailable days for move
  const needsMove = [];
  for(const t of inWeekTasks){
    if(!availableDays.includes(t.nextDue)){
      needsMove.push(t);
    } else {
      dayLoad.set(t.nextDue, (dayLoad.get(t.nextDue)||0) + (Number(t.duration)||0));
    }
  }

  // Sort tasks by duration desc to move heavy ones first (including overloaded days)
  const byDate = [...inWeekTasks].sort((a,b)=> (Number(b.duration)||0) - (Number(a.duration)||0));

  for(const t of byDate){
    const dur = Number(t.duration)||0;
    let cur = t.nextDue;
    let curLoad = availableDays.includes(cur) ? (dayLoad.get(cur)||0) : Infinity; // force move if unavailable

    const overloaded = curLoad > maxCap;
    const mustMove = !availableDays.includes(cur) || overloaded;

    if(!mustMove) continue;

    // Find best candidate day: prefer under target, closest in distance, respecting cap
    let bestDay = null; let bestScore = Infinity;
    for(const d of availableDays){
      const l = dayLoad.get(d)||0;
      if(l + dur > maxCap) continue; // respect cap
      const distance = Math.abs(days.indexOf(d) - days.indexOf(cur));
      const penalty = (l < target ? 0 : (l - target + 1));
      const score = distance * 100 + penalty; // distance dominates, then how far above target
      if(score < bestScore){ bestScore = score; bestDay = d; }
    }

    // Fallback: if nothing fits under cap, put on day with minimal load (still among availableDays)
    if(!bestDay){
      bestDay = availableDays.reduce((minD, d)=> (dayLoad.get(d)||0) < (dayLoad.get(minD)||0) ? d : minD, availableDays[0]);
    }

    // Apply move bookkeeping
    if(availableDays.includes(cur)){
      dayLoad.set(cur, Math.max(0, (dayLoad.get(cur)||0) - dur));
    }
    dayLoad.set(bestDay, (dayLoad.get(bestDay)||0) + dur);
    t.nextDue = bestDay;
  }
  saveAll();
}
      }
    }
    if(bestDay !== cur){
      dayLoad.set(cur, (dayLoad.get(cur)||0) - (Number(t.duration)||0));
      dayLoad.set(bestDay, (dayLoad.get(bestDay)||0) + (Number(t.duration)||0));
      t.nextDue = bestDay;
    }
  }
  saveAll();
}

/***************************************************
 * CRUD SELECTEURS — remplissage des listes
 ***************************************************/
function refreshSelectors(){
  const editSel = document.getElementById('editSel');
  const delSel = document.getElementById('delSel');
  editSel.innerHTML = ''; delSel.innerHTML = '';
  tasks.forEach((t,i)=>{
    const o1 = document.createElement('option'); o1.value = i; o1.textContent = t.name; editSel.appendChild(o1);
    const o2 = document.createElement('option'); o2.value = i; o2.textContent = t.name; delSel.appendChild(o2);
  });
}

/***************************************************
 * EXPORT / IMPORT / CLEAR
 ***************************************************/
function exportJSON(){
  const data = { tasks, absences, logs, prefs };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'organisation-familiale.json'; a.click();
  URL.revokeObjectURL(url);
}

function importJSON(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange = async ()=>{
    const file = inp.files[0]; if(!file) return;
    const txt = await file.text();
    try{ const data = JSON.parse(txt); tasks = data.tasks||[]; absences = data.absences||[]; logs = data.logs||[]; prefs = data.prefs||{}; saveAll(); refreshSelectors(); renderAll(); }
    catch(e){ alert('JSON invalide'); }
  };
  inp.click();
}

function clearAll(){ if(confirm('Effacer toutes les données locales ?')){ tasks=[]; absences=[]; logs=[]; prefs={}; saveAll(); refreshSelectors(); renderAll(); } }

/***************************************************
 * ÉVENEMENTS SUPPLÉMENTAIRES (clavier)
 ***************************************************/
(function wireKeyboard(){
  document.addEventListener('keydown', (e)=>{
    if((prefs.kbdHints||'on')==='off') return;
    if(e.target && (/^(input|select|textarea)$/i).test(e.target.tagName)) return; // éviter dans champs
    if(e.key==='y' || e.key==='Y'){ setWhoFilter('y'); }
    else if(e.key==='m' || e.key==='M'){ setWhoFilter('m'); }
    else if(e.key==='a' || e.key==='A'){ setWhoFilter('all'); }
    else if(e.key==='t' || e.key==='T'){ weekOffset=0; saveWeekOffset(); renderWeek(); }
    else if(e.key==='ArrowLeft'){ weekOffset--; saveWeekOffset(); renderWeek(); }
    else if(e.key==='ArrowRight'){ weekOffset++; saveWeekOffset(); renderWeek(); }
  });
})();
</script>
<!-- FIN PARTIE 2/2 -->
</body>
</html>
