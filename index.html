<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Organisation familiale</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Chart.js (chargé async : protégé côté JS dans renderStats) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" async></script>
<!-- Google Identity Services (auth) + gapi client (Calendar API) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>

<style>
  :root{
    --bg:#f6f7f9; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
    --blue:#2563eb; --yellow:#facc15; --green:#22c55e; --orange:#f59e0b; --red:#ef4444;
    --indigo:#6366f1; --teal:#14b8a6; --pink:#ec4899;
    --red-soft:#fee2e2; --red-soft-dark:rgba(239,68,68,.15);
    --card:#ffffff; --card-soft:#f3f4f6; --shadow:0 1px 3px rgba(0,0,0,.08);
    --ring: 0 0 0 2px rgba(37,99,235,.35);
    --focus-ring: 0 0 0 3px rgba(99,102,241,.4);
    --success-ring: 0 0 0 3px rgba(34,197,94,.35);
    --warning-ring: 0 0 0 3px rgba(245,158,11,.35);
  }
  body.dark{
    --bg:#1f1f23; --panel:#2b2b31; --text:#e5e5e5; --muted:#9ca3af; --line:#3b3b45;
    --card:#2b2b31; --card-soft:#3a3a42; --shadow:0 1px 3px rgba(0,0,0,.35);
    --ring: 0 0 0 2px rgba(99,102,241,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Helvetica Neue",Arial,sans-serif;
    background:var(--bg); color:var(--text); display:flex; height:100vh; overflow:hidden;
    transition:background .3s,color .3s;
  }
  button{font:inherit}
  button:focus{outline:none; box-shadow:var(--ring);} 
  a{color:inherit; text-decoration:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .visually-hidden{clip:rect(0 0 0 0);clip-path:inset(50%);height:1px;overflow:hidden;position:absolute;white-space:nowrap;width:1px}
  .app{display:flex; flex:1; width:100%; height:100%;}
  .left{flex:2; display:flex; flex-direction:column; border-right:1px solid var(--line); min-width:640px;}
  .right{flex:1; display:flex; flex-direction:column; min-width:360px;}
  .bar{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5}
  .title{font-weight:600; font-size:18px}
  .sub{font-size:13px; color:var(--muted)}
  .bar-left{display:flex; flex-direction:column; gap:2px}
  .bar-right{display:flex; align-items:center; gap:8px}
  .btn{background:var(--panel); border:1px solid var(--line); padding:6px 10px; border-radius:8px; cursor:pointer; box-shadow:var(--shadow); color:var(--text)}
  .btn:hover{filter:brightness(0.98)}
  .btn.active{box-shadow:0 0 0 2px rgba(37,99,235,.25) inset; font-weight:600}
  .icon{background:var(--panel); border:1px solid var(--line); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:18px; line-height:1; box-shadow:var(--shadow); color:var(--text)}
  .week-wrap{flex:none; height:640px; overflow:auto; background:var(--panel)}
  .week-view{display:flex; gap:8px; padding:12px; transform:translateX(0); transition:transform .35s ease; height:100%}
  .day{flex:1; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; display:flex; flex-direction:column; align-items:stretch; box-shadow:var(--shadow); min-width:0; height:100%}
  .day-head{display:flex; flex-direction:column; align-items:center; margin-bottom:8px}
  .weekday{font-size:16px; font-weight:500; text-transform:capitalize}
  .date{font-size:12px; color:var(--muted)}
  .today-ring{border:2px solid var(--blue); border-radius:10px; padding:2px 6px}
  .pill{margin-top:6px; background:var(--panel); border-radius:10px; padding:8px; font-size:12px; border-left:6px solid #ccc; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; gap:8px}
  .pill .badge{font-size:11px; padding:2px 6px; border-radius:999px; background:#e5e7eb; color:#111}
  body.dark .pill .badge{background:#444; color:#eee}
  .pill.event{border-left-color:var(--green)}
  .absent{background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.08)); outline:1px dashed rgba(239,68,68,.6);}  
  .day-foot{margin-top:auto; display:flex; flex-direction:column; align-items:center; gap:6px; padding-top:8px}
  .load-chip{font-size:11px; color:var(--muted); background:var(--card-soft); border:1px solid var(--line); border-radius:999px; padding:2px 8px}
  .load-bar{height:8px; width:86%; border-radius:999px; background:var(--line); overflow:hidden; position:relative}
  .load-fill{height:100%; border-radius:999px; width:0}
  .tick{position:absolute; top:50%; transform:translateY(-50%); width:2px; height:8px; background:var(--muted); opacity:.35}
  .month{background:var(--panel); border-top:1px solid var(--line); padding:10px 12px; display:none}
  .month-top{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:6px}
  .month-title{font-weight:600; flex:1; text-align:center}
  .days-head{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:6px; color:var(--muted); font-size:11px; text-align:center}
  .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .cell{width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; user-select:none; background:transparent; border:1px solid var(--line); color:var(--text); transition:transform .08s ease, background .2s ease, border-color .2s ease}
  .cell:hover{transform:scale(1.04)}
  .cell.today{box-shadow:0 0 0 2px var(--blue) inset; border-color:var(--blue); font-weight:700}
  .cell.wknd{background:var(--card-soft); color:var(--muted)}
  .cell.abs{background:var(--red); color:#fff; border-color:var(--red)}
  .right-head{padding:12px 14px; background:var(--panel); border-bottom:1px solid var(--line)}
  .tasks{flex:1; padding:12px; display:grid; grid-template-columns:repeat(3,1fr); gap:10px; overflow:auto}
  .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; text-align:center; box-shadow:var(--shadow); cursor:pointer; transition:transform .12s ease, opacity .25s ease}
  .card:hover{transform:translateY(-1px)}
  .card.fade{opacity:0; transform:scale(.9)}
  .name{font-weight:600; font-size:14px; margin:0; display:flex; align-items:center; gap:8px; justify-content:center}
  .meta{font-size:12px; color:var(--muted); margin-top:4px}
  .days{font-weight:800; font-size:26px; margin-top:6px}
  .upcoming{background:var(--card-soft)}
  body.dark .upcoming{background:var(--card)}
  .late{background:var(--red-soft); border-color:var(--red)}
  body.dark .late{background:var(--red-soft-dark); border-color:var(--red); color:#fca5a5}
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); backdrop-filter:blur(6px); z-index:20}
  .dialog{background:var(--panel); color:var(--text); padding:18px; border-radius:12px; width:min(420px,92vw); box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .dialog h3{margin:0 0 12px 0; font-size:16px; font-weight:600; text-align:center}
  .who{display:flex; gap:10px}
  .wbtn{flex:1; padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:700}
  .wbtn.yonice{background:var(--blue); color:#fff}
  .wbtn.marine{background:var(--yellow); color:#333}
  .panel{position:fixed; top:0; right:-460px; width:460px; height:100%; background:var(--panel); border-left:1px solid var(--line); box-shadow:-4px 0 12px rgba(0,0,0,.12); transition:right .28s ease; z-index:25; display:flex; flex-direction:column}
  .panel.open{right:0}
  .p-head{padding:14px; border-bottom:1px solid var(--line); font-weight:700}
  .p-body{padding:14px; overflow:auto; display:flex; flex-direction:column; gap:12px}
  label{font-size:12px; color:var(--muted)}
  input,select{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:var(--card); color:var(--text)}
  hr{border:none; border-top:1px solid var(--line); margin:6px 0}
  .row{display:flex; gap:8px}
  .row > *{flex:1}
  .chart{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:var(--shadow)}
  @media (max-width:1200px){ .left{min-width:520px} }
  @media (max-width:980px){ .left{min-width:0} .right{min-width:0} .tasks{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:720px){ .app{flex-direction:column} .tasks{grid-template-columns:1fr} }
  .left.abs-open .week-wrap{height:360px}
  .left.abs-open .month{display:block}

  /* === MODIF : suppression bulles, ajout couleurs Y/M === */
  .who-badge{display:none}

  .pill.yonice,
  .card.yonice {
    background: rgba(37,99,235,.12);
    border-left-color: var(--blue);
  }
  .pill.marine,
  .card.marine {
    background: rgba(236,72,153,.12);
    border-left-color: var(--pink);
  }
  /* ====================================================== */

  @media print{
    body{background:#fff}
    .panel, .modal, .right-head, #settingsBtn, #statsBtn, #absenceBtn{display:none!important}
    .left{min-width:0!important}
    .week-wrap{height:auto!important; overflow:visible}
  }
</style>

</head>
<body>
  <div class="app">
    <div class="left">
      <div class="bar">
        <div class="bar-left">
          <div class="title" id="weekTitle">Semaine</div>
          <div class="sub" id="weekSub"></div>
        </div>
        <div class="bar-right">
          <button class="btn" id="prevW" title="Semaine précédente" aria-label="Semaine précédente">‹</button>
          <button class="btn" id="todayBtn" title="Revenir à aujourd’hui" aria-label="Aujourd’hui">Aujourd’hui</button>
          <button class="btn" id="nextW" title="Semaine suivante" aria-label="Semaine suivante">›</button>
          <button class="btn" id="autoBtn" title="Répartir la semaine" aria-label="Répartition auto">↔️</button>
          <div class="who-filter" style="display:flex;gap:6px;margin-left:6px">
            <button class="btn" id="whoAll" title="Toutes les tâches">All</button>
            <button class="btn" id="whoY" title="Tâches de Yonice">Y</button>
            <button class="btn" id="whoM" title="Tâches de Marine">M</button>
          </div>
          <button class="icon" id="absenceBtn" title="Absences" aria-label="Absences">💼</button>
          <button class="icon" id="statsBtn" title="Statistiques" aria-label="Statistiques">📈</button>
          <button class="icon" id="settingsBtn" title="Paramètres" aria-label="Paramètres">⚙️</button>
        </div>
      </div>
      <div class="week-wrap"><div class="week-view" id="weekView"></div></div>
      <div class="month" id="absencePanel">
        <div class="month-top">
          <button class="btn" id="prevM" title="Mois précédent">‹</button>
          <div class="month-title" id="monthTitle">Mois</div>
          <button class="btn" id="nextM" title="Mois suivant">›</button>
          <button class="btn" id="closeAbs" title="Fermer">✖</button>
        </div>
        <div class="days-head"><div>lu</div><div>ma</div><div>me</div><div>je</div><div>ve</div><div>sa</div><div>di</div></div>
        <div class="grid" id="monthGrid"></div>
      </div>
    </div>
    <div class="right">
      <div class="right-head">
        <div class="title" style="font-size:16px">9 prochaines tâches</div>
        <div class="sub">Appuie pour valider (popup Yonice / Marine)</div>
      </div>
      <div class="tasks" id="tasksGrid"></div>
    </div>
  </div>
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTaskName">
    <div class="dialog">
      <h3 id="modalTaskName">Qui a fait… ?</h3>
      <div class="who">
        <button class="wbtn yonice" id="whoYonice">Yonice</button>
        <button class="wbtn marine" id="whoMarine">Marine</button>
      </div>
    </div>
  </div>
  <div class="panel" id="settingsPanel" aria-label="Panneau paramètres">
    <div class="p-head">Paramètres</div>
    <div class="p-body">
      <div class="row">
        <button class="btn" id="themeToggle">Basculer clair / sombre</button>
        <label style="display:flex; align-items:center; gap:8px"><input type="checkbox" id="autoChk"> Auto-répartir après chaque changement</label>
      </div>
      <hr>
      <div style="font-weight:600">⚙️ Objectifs</div>
      <div class="row">
        <div><label>Plafond (min)</label><input id="targetInput" type="number" min="10" step="5" value="75"></div>
        <div><label>Cible idéale (min)</label><input id="maxInput" type="number" min="10" step="5" value="90"></div>
      </div>
      <div class="row">
        <div><label>Inclure événements Google dans la charge</label>
          <select id="eventsWeight">
            <option value="0">Ignorer (0 min)</option>
            <option value="dur">Durée réelle (si dispo)</option>
            <option value="30">Forfait 30 min</option>
            <option value="60">Forfait 60 min</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Masquer les week-ends</label>
          <select id="hideWeekends">
            <option value="no">Afficher</option>
            <option value="yes">Masquer</option>
          </select>
        </div>
        <div><label>Rappels clavier (A/Y/M/T)</label>
          <select id="kbdHints">
            <option value="on">Activer</option>
            <option value="off">Désactiver</option>
          </select>
        </div>
      </div>
      <hr>
      <div style="font-weight:600">➕ Ajouter une tâche</div>
      <div class="row">
        <div><label>Nom</label><input id="addName" placeholder="Ex. Nettoyer frigo"></div>
        <div><label>Durée (min)</label><input id="addDur" type="number" min="1" step="1" value="30"></div>
        <div><label>Fréquence (jours)</label><input id="addFreq" type="number" min="1" step="1" value="7"></div>
      </div>
      <button class="btn" id="addBtn">Ajouter</button>
      <hr>
      <div style="font-weight:600">✏️ Modifier une tâche</div>
      <div><label>Choisir</label><select id="editSel"></select></div>
      <div class="row">
        <div><label>Nom</label><input id="editName"></div>
        <div><label>Durée</label><input id="editDur" type="number" min="1"></div>
        <div><label>Fréquence</label><input id="editFreq" type="number" min="1"></div>
      </div>
      <button class="btn" id="saveEdit">Enregistrer</button>
      <hr>
      <div style="font-weight:600">🗑️ Supprimer une tâche</div>
      <div><label>Choisir</label><select id="delSel"></select></div>
      <button class="btn" id="delBtn">Supprimer</button>
      <hr>
      <div style="font-weight:600">🧹 Données</div>
      <div class="row">
        <button class="btn" id="exportBtn">Exporter JSON</button>
        <button class="btn" id="importBtn">Importer JSON</button>
        <button class="btn" id="clearBtn">Réinitialiser</button>
      </div>
    </div>
  </div>
  <div class="panel" id="statsPanel" aria-label="Panneau statistiques">
    <div class="p-head">Statistiques</div>
    <div class="p-body">
      <div><label>Période</label>
        <select id="statsFilter">
          <option value="month">Ce mois</option>
          <option value="year">Cette année</option>
        </select>
      </div>
      <div class="chart"><canvas id="pie"></canvas></div>
      <div class="chart"><canvas id="bars"></canvas></div>
      <div class="chart"><canvas id="daily"></canvas></div>
    </div>
  </div>

<!-- ==========================
     =  SCRIPT — PARTIE 1/3  =
     ==========================
     Base + config + helpers + placeholders
-->
<script>
/***************************************************
 * CONFIG — Google API (Calendar) via GIS
 ***************************************************/
const CLIENT_ID = "691551955911-i6mhvllgop4f1u5q2k144tmqvt6q2pei.apps.googleusercontent.com";
const SCOPES    = "https://www.googleapis.com/auth/calendar.readonly";
let tokenClient; // GIS token client
let gapiInited = false; let gisInited = false;
let events = []; // Google Calendar events

// Chargement du client gapi + demande de token via GIS
window.addEventListener('load', () => {
  if (window.gapi){
    gapi.load('client', async () => {
      try{
        await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
        gapiInited = true; maybeEnable();
      }catch(e){ console.warn('gapi init error', e); }
    });
  }
  const iv = setInterval(() => {
    if (window.google && window.google.accounts && window.google.accounts.oauth2){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if (resp && resp.access_token){
            gapi.client.setToken({access_token: resp.access_token});
            await listEvents();
          }
        }
      });
      gisInited = true; maybeEnable();
      clearInterval(iv);
    }
  }, 60);
});

function maybeEnable(){
  if (gapiInited && gisInited){
    const haveToken = !!(gapi.client && gapi.client.getToken && gapi.client.getToken());
    tokenClient.requestAccessToken({ prompt: haveToken ? 'none' : 'consent' });
  }
}

async function listEvents(){
  try{
    const resp = await gapi.client.calendar.events.list({
      calendarId: 'primary',
      timeMin: new Date().toISOString(),
      showDeleted: false,
      singleEvents: true,
      maxResults: 100,
      orderBy: 'startTime'
    });
    events = resp.result.items || [];
    renderAll();
  }catch(e){ console.warn('Erreur events', e); }
}

/***************************************************
 * STORAGE & DATA
 ***************************************************/
const TASKS_KEY='tasks_v8';
const ABS_KEY='absences_v8';
const LOGS_KEY='logs_v8';
const PREF_KEY='prefs_v8';

let tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
let absences = JSON.parse(localStorage.getItem(ABS_KEY) || '[]');
let logs = JSON.parse(localStorage.getItem(LOGS_KEY) || '[]');
let prefs = JSON.parse(localStorage.getItem(PREF_KEY) || '{}');

function saveAll(){
  localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
  localStorage.setItem(ABS_KEY, JSON.stringify(absences));
  localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
  localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
}

/***************************************************
 * DATE UTILS
 ***************************************************/
const pad = n => String(n).padStart(2,'0');
const toISODateLocal = (d)=>{ const x = new Date(d); const y = new Date(x.getFullYear(), x.getMonth(), x.getDate()); return `${y.getFullYear()}-${pad(y.getMonth()+1)}-${pad(y.getDate())}`; };
const todayISO = () => toISODateLocal(new Date());
const addDaysISO = (iso, n)=>{ const [Y,M,D] = iso.split('-').map(Number); return toISODateLocal(new Date(Y, M-1, D + n)); };
const mondayOf = (weekOffset=0) => { const now = new Date(); const wd = (now.getDay()||7); const monday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - wd + 1 + weekOffset*7); return toISODateLocal(monday); };
const frDay = d => new Date(d).toLocaleDateString('fr-FR',{weekday:'long'});
const frDate = d => new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'long'});
function getWeekNumber(d){ d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }
const isWeekend = iso => { const wd = new Date(iso).getDay(); return wd===0 || wd===6; };

/***************************************************
 * HELPERS
 ***************************************************/
function uid(){ return Math.random().toString(36).slice(2,10); }
function groupByDate(items, getDateStr){ const map = new Map(); for(const it of items){ const k = getDateStr(it); if(!map.has(k)) map.set(k, []); map.get(k).push(it);} return map; }
function minutesBetween(start, end){ const s = new Date(start).getTime(); const e = new Date(end).getTime(); if(!isFinite(s)||!isFinite(e)|| e<=s) return 0; return Math.round((e-s)/60000); }

/***************************************************
 * WHO FILTER — état global + helpers UI
 ***************************************************/
let whoFilter = 'all';
function applyWhoFilterUI(){
  const a=document.getElementById('whoAll'); const y=document.getElementById('whoY'); const m=document.getElementById('whoM');
  if(!a||!y||!m) return;
  a.classList.toggle('active', whoFilter==='all');
  y.classList.toggle('active', whoFilter==='y');
  m.classList.toggle('active', whoFilter==='m');
}
function setWhoFilter(f){
  whoFilter = f; prefs.whoFilter=f; saveAll();
  applyWhoFilterUI();
  renderWeek();
  rebuildUpcoming();
}

/***************************************************
 * UI BUILDERS (pills)
 ***************************************************/
function makePill(text, classes=[], badgeText, who){
  const d = document.createElement('div'); 
  d.className = 'pill ' + classes.join(' ');

  // Ajoute couleur selon "who"
  if (who === 'Yonice') d.classList.add('who-yonice');
  if (who === 'Marine') d.classList.add('who-marine');

  const left = document.createElement('span'); 
  left.textContent = text; 
  d.appendChild(left);

  if (badgeText !== undefined){ 
    const b = document.createElement('span'); 
    b.className='badge'; 
    b.textContent = badgeText; 
    d.appendChild(b); 
  }

  // plus de who-badge ici
  return d;
}

/***************************************************
 * ÉTAT DERNIER QUI (lastWhoMap)
 ***************************************************/
let lastWhoMap = new Map();
function rebuildLastWhoMap(){
  lastWhoMap = new Map();
  for(let i=logs.length-1;i>=0;i--){
    const l = logs[i];
    if(!lastWhoMap.has(l.taskId)) lastWhoMap.set(l.taskId, l.who);
  }
}

/***************************************************
 * RENDER ALL
 ***************************************************/
function renderAll(){
  tasks.forEach(recomputeNextDue);
  rebuildLastWhoMap();
  saveAll();
  renderWeek();
  rebuildUpcoming();
}

/***************************************************
 * PLACEHOLDERS (implémentés en PARTIE 2/3)
 ***************************************************/
function renderWeek(){}
function rebuildUpcoming(){}
function openModal(taskIndex){}
function renderMonth(){}
function renderStats(){}
function distributeWeek(){}
function refreshSelectors(){}
function recomputeNextDue(task){ if(!task.nextDue){ task.nextDue = todayISO(); } }
function exportJSON(){}
function importJSON(){}
function clearAll(){}

/***************************************************
 * INIT UI + EVENTS
 ***************************************************/
function initUI(){
  // Thème
  if(prefs.theme==='dark') document.body.classList.add('dark');

  // Restauration préférences
  if(prefs.target) document.getElementById('targetInput').value = prefs.target;
  if(prefs.maxCap) document.getElementById('maxInput').value = prefs.maxCap;
  if(prefs.eventsWeight) document.getElementById('eventsWeight').value = prefs.eventsWeight;
  if(prefs.hideWeekends) document.getElementById('hideWeekends').value = prefs.hideWeekends;
  if(prefs.kbdHints) document.getElementById('kbdHints').value = prefs.kbdHints;
  if(prefs.auto) document.getElementById('autoChk').checked = !!prefs.auto;
  whoFilter = prefs.whoFilter || 'all';
  applyWhoFilterUI();

  // Nav semaine
  document.getElementById('todayBtn').addEventListener('click', ()=>{ weekOffset=0; renderWeek(); });
  document.getElementById('prevW').addEventListener('click', ()=>{ weekOffset--; saveWeekOffset(); renderWeek(); });
  document.getElementById('nextW').addEventListener('click', ()=>{ weekOffset++; saveWeekOffset(); renderWeek(); });
  document.getElementById('autoBtn').addEventListener('click', ()=>{ distributeWeek(); renderWeek(); });

  // Panneaux
  const settingsPanel = document.getElementById('settingsPanel');
  document.getElementById('settingsBtn').addEventListener('click', ()=> settingsPanel.classList.toggle('open'));
  document.getElementById('themeToggle').addEventListener('click', ()=> { document.body.classList.toggle('dark'); prefs.theme = document.body.classList.contains('dark')? 'dark':'light'; saveAll(); });

  const statsPanel = document.getElementById('statsPanel');
  document.getElementById('statsBtn').addEventListener('click', ()=> { statsPanel.classList.toggle('open'); setTimeout(renderStats, 0); });
  document.getElementById('statsFilter').addEventListener('change', renderStats);

  // WHO Filter
  document.getElementById('whoAll').addEventListener('click', ()=> setWhoFilter('all'));
  document.getElementById('whoY').addEventListener('click', ()=> setWhoFilter('y'));
  document.getElementById('whoM').addEventListener('click', ()=> setWhoFilter('m'));

  // Objectifs / prefs live
  document.getElementById('targetInput').addEventListener('input', ()=>{ prefs.target = Number(document.getElementById('targetInput').value)||75; saveAll(); renderWeek(); });
  document.getElementById('maxInput').addEventListener('input', ()=>{ prefs.maxCap = Number(document.getElementById('maxInput').value)||90; saveAll(); renderWeek(); });
  document.getElementById('eventsWeight').addEventListener('change', ()=>{ prefs.eventsWeight = document.getElementById('eventsWeight').value; saveAll(); renderWeek(); });
  document.getElementById('hideWeekends').addEventListener('change', ()=>{ prefs.hideWeekends = document.getElementById('hideWeekends').value; saveAll(); renderWeek(); });
  document.getElementById('kbdHints').addEventListener('change', ()=>{ prefs.kbdHints = document.getElementById('kbdHints').value; saveAll(); });
  document.getElementById('autoChk').addEventListener('change', (e)=>{ prefs.auto = e.target.checked; saveAll(); });

  // Données
  document.getElementById('exportBtn').addEventListener('click', exportJSON);
  document.getElementById('importBtn').addEventListener('click', importJSON);
  document.getElementById('clearBtn').addEventListener('click', clearAll);

  refreshSelectors();
}

/***************************************************
 * PERSISTENCE DE LA POSITION SEMAINE
 ***************************************************/
let weekOffset = Number(localStorage.getItem('weekOffset')||0) || 0;
function saveWeekOffset(){ localStorage.setItem('weekOffset', String(weekOffset)); }

/***************************************************
 * BOOT
 ***************************************************/
(function boot(){
  if(tasks.length===0){
    tasks = [
      { id: uid(), name:'Vaisselle', duration:30, freq:1, nextDue: todayISO() },
      { id: uid(), name:'Lessive', duration:45, freq:3, nextDue: addDaysISO(todayISO(),1) },
      { id: uid(), name:'Courses', duration:60, freq:7, nextDue: addDaysISO(todayISO(),2) },
      { id: uid(), name:'Aspirateur', duration:25, freq:4, nextDue: addDaysISO(todayISO(),1) },
      { id: uid(), name:'Salle de bain', duration:40, freq:7, nextDue: addDaysISO(todayISO(),3) },
      { id: uid(), name:'Poubelles', duration:15, freq:2, nextDue: todayISO() },
      { id: uid(), name:'Cuisine', duration:35, freq:5, nextDue: addDaysISO(todayISO(),4) },
      { id: uid(), name:'Arrosage plantes', duration:20, freq:3, nextDue: addDaysISO(todayISO(),5) },
      { id: uid(), name:'Litière', duration:15, freq:3, nextDue: addDaysISO(todayISO(),6) }
    ];
  }
  initUI();
  renderAll();
})();
</script>
<!-- ===== FIN PARTIE 1/3 — Colle la PARTIE 2/3 ici (après ce script) -->
<!-- ==========================
     =  SCRIPT — PARTIE 2/3  =
     ==========================
     Implémente renderWeek, rebuildUpcoming, openModal (A11y), renderMonth,
     renderStats (guard Chart.js), distributeWeek (corrigée)
-->
<script>
/***************************************************
 * RENDER SEMAINE — hauteur fixe + jauges + filtre Y/M
 ***************************************************/

function renderWeek(){
  const week = document.getElementById('weekView') || document.getElementById('week');
  if (!week) return;
  week.innerHTML = '';

  const mondayISO_ = mondayOf(weekOffset);
  const days = Array.from({length:7}, (_,i)=> addDaysISO(mondayISO_, i));

  const target = Number(document.getElementById('targetInput')?.value) || 75;
  const maxCap = Number(document.getElementById('maxInput')?.value) || 90;

  const whoFilter = document.querySelector('#whoFilter input:checked')?.value || 'all';

  const fmtWeekday = new Intl.DateTimeFormat('fr-FR',{ weekday:'long' });
  const fmtDate    = new Intl.DateTimeFormat('fr-FR',{ day:'2-digit', month:'2-digit' });

  const dayLoad = (dISO) => {
    return tasks
      .filter(t => t.nextDue === dISO)
      .reduce((sum,t)=> sum + (Number(t.duration)||0), 0);
  };

  for (const d of days){
    const col = document.createElement('div');
    col.className = 'day';
    col.dataset.date = d;

    // En-tête jour
    const head = document.createElement('div');
    head.className = 'day-head';

    const dt = new Date(d + 'T00:00:00');
    const wk  = document.createElement('div');
    wk.className = 'weekday';
    wk.textContent = fmtWeekday.format(dt);
    head.appendChild(wk);

    const dd = document.createElement('div');
    dd.className = 'date';
    dd.textContent = fmtDate.format(dt);
    head.appendChild(dd);

    if (d === todayISO()) head.classList.add('today-ring');

    col.appendChild(head);

    // Tâches du jour
    const todays = tasks
      .map((t, idx) => ({ ...t, _idx: idx }))
      .filter(t => t.nextDue === d)
      .filter(t => {
        const lw = lastWhoMap.get(t.id) ?? lastWhoMap.get(t._idx);
        if (whoFilter === 'all') return true;
        if (whoFilter === 'y')   return lw === undefined || lw === 'Yonice';
        if (whoFilter === 'm')   return lw === undefined || lw === 'Marine';
        return true;
      });

    for (const t of todays){
      const pill = document.createElement('div');
      pill.className = 'pill';
      pill.tabIndex = 0;

      // Couleur selon la personne
      const lw = lastWhoMap.get(t.id) ?? lastWhoMap.get(t._idx);
      if (lw === 'Yonice') pill.classList.add('yonice');
      if (lw === 'Marine') pill.classList.add('marine');

      // Nom de la tâche
      const left = document.createElement('span');
      left.textContent = t.name;
      pill.appendChild(left);

      // Petite bulle : seulement la durée
      const meta = document.createElement('span');
      meta.className = 'badge';
      meta.textContent = `${Number(t.duration||0)}m`;
      pill.appendChild(meta);

      pill.addEventListener('click', () => openModal(t._idx));
      col.appendChild(pill);
    }

    // Pied de colonne
    const load = dayLoad(d);

    const foot = document.createElement('div');
    foot.className = 'day-foot';

    const chip = document.createElement('div');
    chip.className = 'load-chip';
    chip.textContent = `${load} / ${maxCap} min`;
    foot.appendChild(chip);

    const bar = document.createElement('div');
    bar.className = 'load-bar';

    const fill = document.createElement('div');
    fill.className = 'load-fill';
    const pct = Math.max(0, Math.min(100, (load / Math.max(1, maxCap)) * 100));
    fill.style.width = pct + '%';
    fill.style.background = pct >= 100 ? 'var(--red)' : 'var(--blue)';
    bar.appendChild(fill);

    const tickTarget = document.createElement('div');
    tickTarget.className = 'tick';
    tickTarget.style.left = Math.max(0, Math.min(100, (target / Math.max(1, maxCap)) * 100)) + '%';
    bar.appendChild(tickTarget);

    const tickMax = document.createElement('div');
    tickMax.className = 'tick';
    tickMax.style.left = '100%';
    bar.appendChild(tickMax);

    foot.appendChild(bar);
    col.appendChild(foot);

    week.appendChild(col);
  }
}


/***************************************************
 * 9 PROCHAINES TÂCHES — filtre Y/M appliqué
 ***************************************************/

function rebuildUpcoming(){
  const grid = document.getElementById('tasksGrid');
  if (!grid) return;
  grid.innerHTML = '';

  // Filtre "Qui" (radio), par défaut "all"
  const whoFilter = document.querySelector('#whoFilter input:checked')?.value || 'all';

  // Source + index d'origine pour compatibilité avec lastWhoMap
  const itemsAll = tasks
    .map((t, idx) => ({ ...t, _idx: idx }))
    .filter(t => t.nextDue); // on ne garde que celles avec une date

  // Ne pas masquer les tâches sans historique
  const filtered = itemsAll
    .filter(t => {
      const lw = lastWhoMap.get(t.id) ?? lastWhoMap.get(t._idx);
      if (whoFilter === 'all') return true;
      if (whoFilter === 'y')   return lw === undefined || lw === 'Yonice';
      if (whoFilter === 'm')   return lw === undefined || lw === 'Marine';
      return true;
    })
    .sort((a,b) => a.nextDue.localeCompare(b.nextDue))
    .slice(0, 9);

  const frag = document.createDocumentFragment();
  const today = new Date(todayISO());

  for (const t of filtered){
    const d = new Date(t.nextDue);
    const delta = Math.floor((d - today) / 86400000);

    const card = document.createElement('div');
    card.className = 'card ' + (delta < 0 ? 'late' : 'upcoming');

    // Couleur selon la dernière personne (remplace les anciennes bulles)
    const lw = lastWhoMap.get(t.id) ?? lastWhoMap.get(t._idx);
    if (lw === 'Yonice') card.classList.add('yonice');
    if (lw === 'Marine') card.classList.add('marine');

    card.tabIndex = 0;

    // Nom
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = t.name;
    card.appendChild(name);

    // Métadonnées
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = `${t.nextDue} · ${t.duration} min · tous ${t.freq} j`;
    card.appendChild(meta);

    // Indicateur J-?
    const days = document.createElement('div');
    days.className = 'days';
    days.textContent = (delta < 0)
      ? `${Math.abs(delta)} j de retard`
      : (delta === 0 ? "aujourd'hui" : `J-${delta}`);
    card.appendChild(days);

    // Clic → modal (édition/validation)
    card.addEventListener('click', () => openModal(t._idx));

    frag.appendChild(card);
  }

  grid.appendChild(frag);
}

/***************************************************
 * MODAL — validation et logging (A11y + focus trap)
 ***************************************************/
function openModal(taskIndex){
  const t = tasks[taskIndex];
  const modal = document.getElementById('modal');
  const btnY = document.getElementById('whoYonice');
  const btnM = document.getElementById('whoMarine');
  const title = document.getElementById('modalTaskName');
  const prevActive = document.activeElement;

  title.textContent = `Qui a fait: ${t.name} ?`;
  modal.style.display='flex';
  btnY.focus();

  const close = ()=>{ modal.style.display='none'; document.removeEventListener('keydown', onKey); if(prevActive) prevActive.focus(); };
  const validate = who =>{
    logs.push({date: todayISO(), taskId: t.id ?? taskIndex, who, duration: t.duration||0});
    const base = t.nextDue && new Date(t.nextDue) > new Date(todayISO()) ? t.nextDue : todayISO();
    t.nextDue = addDaysISO(base, t.freq||7);
    saveAll();
    close();
    if(document.getElementById('autoChk').checked){ distributeWeek(); }
    renderAll();
  };

  btnY.onclick = ()=> validate('Yonice');
  btnM.onclick = ()=> validate('Marine');

  function onKey(e){
    if(e.key==='Escape'){ e.preventDefault(); close(); }
    if(e.key==='Tab'){
      if(e.shiftKey && document.activeElement===btnY){ e.preventDefault(); btnM.focus(); }
      else if(!e.shiftKey && document.activeElement===btnM){ e.preventDefault(); btnY.focus(); }
    }
  }
  document.addEventListener('keydown', onKey);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); }, { once:true });
}

/***************************************************
 * ABSENCES — calendrier mensuel et toggle hauteur
 ***************************************************/
let monthCursor = toISODateLocal(new Date());
function renderMonth(){
  const [Y,M] = monthCursor.split('-').map(Number);
  const first = new Date(Y, M-1, 1);
  const firstWeekday = (first.getDay()||7);
  const daysInMonth = new Date(Y, M, 0).getDate();
  const grid = document.getElementById('monthGrid');
  grid.innerHTML = '';
  document.getElementById('monthTitle').textContent = first.toLocaleDateString('fr-FR', {month:'long', year:'numeric'});

  for(let b=1; b<firstWeekday; b++){ const ph = document.createElement('div'); grid.appendChild(ph); }
  for(let d=1; d<=daysInMonth; d++){
    const iso = toISODateLocal(new Date(Y, M-1, d));
    const cell = document.createElement('div');
    cell.className = 'cell' + (isWeekend(iso)? ' wknd':'');
    if(iso===todayISO()) cell.classList.add('today');
    if(absences.includes(iso)) cell.classList.add('abs');
    cell.textContent = d;
    cell.addEventListener('click', ()=>{
      const idx = absences.indexOf(iso);
      if(idx>=0) absences.splice(idx,1); else absences.push(iso);
      saveAll(); renderMonth(); renderWeek();
    });
    grid.appendChild(cell);
  }
}

(function wireAbsences(){
  const absPanel = document.getElementById('absencePanel');
  document.getElementById('absenceBtn').addEventListener('click', ()=>{
    const left = document.querySelector('.left');
    absPanel.style.display='block';
    left.classList.add('abs-open');
    renderMonth();
  });
  document.getElementById('closeAbs').addEventListener('click', ()=>{
    const left = document.querySelector('.left');
    absPanel.style.display='none';
    left.classList.remove('abs-open');
    renderWeek();
  });
  document.getElementById('prevM').addEventListener('click', ()=>{ const d=new Date(monthCursor); d.setMonth(d.getMonth()-1); monthCursor=toISODateLocal(d); renderMonth(); });
  document.getElementById('nextM').addEventListener('click', ()=>{ const d=new Date(monthCursor); d.setMonth(d.getMonth()+1); monthCursor=toISODateLocal(d); renderMonth(); });
})();

/***************************************************
 * STATS — Chart.js (camembert + barres + courbe) avec garde
 ***************************************************/
let pieChart, barChart, dailyChart;
function renderStats(){
  if(typeof Chart === 'undefined'){ return; } // Chart.js pas encore prêt
  const period = document.getElementById('statsFilter').value; // 'month' | 'year'
  const now = new Date();
  const start = period==='month' ? new Date(now.getFullYear(), now.getMonth(), 1) : new Date(now.getFullYear(), 0, 1);
  const startISO = toISODateLocal(start);
  const filt = logs.filter(l => l.date >= startISO);

  const sumByWho = { Yonice:0, Marine:0 };
  const byDay = {};
  for(const l of filt){ sumByWho[l.who] = (sumByWho[l.who]||0) + (l.duration||0); byDay[l.date] = (byDay[l.date]||0) + (l.duration||0); }

  const pctx = document.getElementById('pie'); if (pieChart) pieChart.destroy();
  pieChart = new Chart(pctx, { type:'pie', data:{ labels:Object.keys(sumByWho), datasets:[{ data:Object.values(sumByWho) }] }, options:{ responsive:true } });

  const labels = []; const data = [];
  for(let i=6;i>=0;i--){ const iso = addDaysISO(todayISO(), -i); labels.push(new Date(iso).toLocaleDateString('fr-FR',{weekday:'short'})); data.push(byDay[iso]||0); }
  const bctx = document.getElementById('bars'); if (barChart) barChart.destroy();
  barChart = new Chart(bctx, { type:'bar', data:{ labels, datasets:[{ label:'Durée (min)', data }] }, options:{ responsive:true } });

  const labels2 = []; const data2 = [];
  for(let i=13;i>=0;i--){ const iso = addDaysISO(todayISO(), -i); labels2.push(iso.slice(5)); let s=0; const dTasks = tasks.filter(t=>t.nextDue===iso); dTasks.forEach(t=> s+= Number(t.duration)||0); data2.push(s); }
  const dctx = document.getElementById('daily'); if (dailyChart) dailyChart.destroy();
  dailyChart = new Chart(dctx, { type:'line', data:{ labels:labels2, datasets:[{ label:'Charge tâches (min)', data:data2, tension:.3 }] }, options:{ responsive:true } });
}

/***************************************************
 * DISTRIBUTION — heuristique corrigée (SUPPRIME le doublon)
 ***************************************************/
function distributeWeek(){
  const target = Number(document.getElementById('targetInput').value) || 75;
  const maxCap = Number(document.getElementById('maxInput').value) || 90;
  const hideWeekendsPref = (document.getElementById('hideWeekends').value || 'no') === 'yes';

  const mondayISO_ = mondayOf(weekOffset);
  const weekDays = Array.from({length: 7}, (_, i) => addDaysISO(mondayISO_, i));
  const availableDays = weekDays.filter(d => !hideWeekendsPref || !isWeekend(d));

  // Helpers
  const isAbsence = (d) => Array.isArray(absences) && absences.includes(d);

  // Dernier jour de la séquence d'absence contenant d
  const endOfAbsence = (d) => {
    let cur = d;
    while (isAbsence(cur)) cur = addDaysISO(cur, 1);
    return addDaysISO(cur, -1);
  };

  // Premier jour ouvré après une date (saute absences et week-ends si masqués)
  const nextWorkingDayAfter = (d) => {
    let cur = addDaysISO(d, 1);
    while (isAbsence(cur)) cur = addDaysISO(cur, 1);
    while (hideWeekendsPref && isWeekend(cur)) cur = addDaysISO(cur, 1);
    return cur;
  };

  // Charges initiales pour la semaine affichée
  const load = new Map(availableDays.map(d => [d, 0]));
  const inWeek = tasks.filter(t => weekDays.includes(t.nextDue));

  for (const t of inWeek) {
    const d = t.nextDue;
    if (availableDays.includes(d) && !isAbsence(d)) {
      load.set(d, (load.get(d) || 0) + (Number(t.duration) || 0));
    }
  }

  // Traiter d'abord les plus longues
  const sorted = [...inWeek].sort((a, b) => (Number(b.duration) || 0) - (Number(a.duration) || 0));

  for (const t of sorted) {
    const dur = Number(t.duration) || 0;
    const original = t.nextDue;
    const curDay = original;

    // 1) Si la tâche tombe pendant une absence, base = premier jour ouvré après la PLAGE d'absence
    let base = original;
    if (isAbsence(original)) {
      const endAbs = endOfAbsence(original);
      base = nextWorkingDayAfter(endAbs);
    }

    // 2) Correctif "dimanche" / hors semaine: si base n'est pas dans la semaine affichée,
    // on pose directement sur base (semaine suivante typiquement) et on passe à la suivante.
    const baseIdx = weekDays.indexOf(base);
    if (baseIdx === -1) {
      if (availableDays.includes(curDay) && !isAbsence(curDay)) {
        load.set(curDay, Math.max(0, (load.get(curDay) || 0) - dur));
      }
      t.nextDue = base;
      continue;
    }

    // 2bis) Si PAS d'absence, que le jour courant est dispo, et que sa charge (déjà incluant la tâche)
    // ne dépasse pas maxCap, on ne touche à rien (évite les déplacements "sans raison").
    if (!isAbsence(original) && availableDays.includes(curDay)) {
      const lcur = load.get(curDay) || 0;
      if (lcur <= maxCap) {
        // rien à faire, on garde la tâche en place
        continue;
      }
    }

    // 3) Recherche strictement APRÈS base (jamais avant)
    const forwardDays = availableDays.filter(d => weekDays.indexOf(d) >= baseIdx);
    const candidates = forwardDays.length ? forwardDays : [];

    // Fonctions de test de capacité et de charge effective (sans double comptage sur le jour courant)
    const canFit = (d) => {
      const l = load.get(d) || 0;
      if (d === curDay) return l <= maxCap && !isAbsence(d);
      return (l + dur) <= maxCap && !isAbsence(d);
    };
    const effectiveLoadIfPlaced = (d) => {
      const l = load.get(d) || 0;
      return d === curDay ? l : l + dur;
    };

    // 4) Choix du jour
    let chosen = null;

    // 4a) Essayer de respecter maxCap si possible
    for (const d of candidates) {
      if (canFit(d)) { chosen = d; break; }
    }

    // 4b) Sinon, choisir APRÈS le moins chargé après placement, quitte à dépasser maxCap
    if (!chosen && candidates.length) {
      chosen = candidates.reduce((best, d) => {
        const lb = effectiveLoadIfPlaced(best);
        const ld = effectiveLoadIfPlaced(d);
        if (ld < lb) return d;
        if (ld === lb) {
          // tie-breaker: plus proche de base
          const di = weekDays.indexOf(d);
          const bi = weekDays.indexOf(best);
          return Math.abs(di - baseIdx) < Math.abs(bi - baseIdx) ? d : best;
        }
        return best;
      }, candidates[0]);
    }

    // 5) Appliquer le déplacement si choisi et différent
    if (chosen && chosen !== t.nextDue) {
      if (availableDays.includes(curDay) && !isAbsence(curDay)) {
        load.set(curDay, Math.max(0, (load.get(curDay) || 0) - dur));
      }
      load.set(chosen, (load.get(chosen) || 0) + (chosen === curDay ? 0 : dur));
      t.nextDue = chosen;
    }
  }

  saveAll();
}
</script>
<!-- ===== FIN PARTIE 2/3 — Colle la PARTIE 3/3 ici (après ce script) -->
<!-- ==========================
     =  SCRIPT — PARTIE 3/3  =
     ==========================
     CRUD sélecteurs, export/import robustes, clear, raccourcis clavier,
     fermeture du document.
-->
<script>
/***************************************************
 * CRUD SELECTEURS — remplissage des listes
 ***************************************************/
function refreshSelectors(){
  // Références DOM
  const addBtn   = document.getElementById('addBtn');
  const addName  = document.getElementById('addName');
  const addDur   = document.getElementById('addDur');
  const addFreq  = document.getElementById('addFreq');

  const targetInput = document.getElementById('targetInput');
  const maxInput    = document.getElementById('maxInput');
  const hideWE      = document.getElementById('hideWeekends');

  // Édition / suppression
  const editSel  = document.getElementById('editSel');
  const editName = document.getElementById('editName');
  const editDur  = document.getElementById('editDur');
  const editFreq = document.getElementById('editFreq');
  const editDue  = document.getElementById('editDue');   // champ date
  const saveEdit = document.getElementById('saveEdit');

  const delSel   = document.getElementById('delSel');
  const delBtn   = document.getElementById('delBtn');

  // Raccourcis utilitaires
  const hideWeekendsPref = () => (document.getElementById('hideWeekends')?.value || 'no') === 'yes';
  const isAbsent = d => Array.isArray(absences) && absences.includes(d);

  // Helpers d’alignement de date
  function endOfAbsence(d){
    // renvoie le dernier jour de la plage d'absence qui contient d, ou d si non absent
    if (!isAbsent(d)) return d;
    let cur = d;
    while (isAbsent(cur)) cur = addDaysISO(cur, 1);
    return addDaysISO(cur, -1);
  }
  function nextWorkingDayAfter(d){
    // saute les absences et, si demandé, les week-ends
    let cur = addDaysISO(d, 1);
    while (isAbsent(cur)) cur = addDaysISO(cur, 1);
    if (hideWeekendsPref()){
      while (isWeekend(cur)) cur = addDaysISO(cur, 1);
    }
    return cur;
  }
  function normalizeDueDate(dateISO){
    let out = dateISO;

    // 1) si on tombe dans une absence, on pousse après la fin de la plage
    if (isAbsent(out)){
      const endAbs = endOfAbsence(out);
      out = nextWorkingDayAfter(endAbs);
    }

    // 2) si les week-ends sont masqués et que la date est un week-end, on pousse au lundi
    if (hideWeekendsPref() && isWeekend(out)){
      // aller au lundi suivant
      let cur = out;
      while (isWeekend(cur)) cur = addDaysISO(cur, 1);
      out = cur;
    }

    return out;
  }

  // Réglages (sauvegarde + rerender)
  if (targetInput && !targetInput._bound){
    targetInput._bound = true;
    targetInput.onchange = () => { saveAll(); renderAll(); };
  }
  if (maxInput && !maxInput._bound){
    maxInput._bound = true;
    maxInput.onchange = () => { saveAll(); renderAll(); };
  }
  if (hideWE && !hideWE._bound){
    hideWE._bound = true;
    hideWE.onchange = () => { saveAll(); renderAll(); };
  }

  // Filtre "Qui" (Y / M / All)
  const whoFilterWrap = document.getElementById('whoFilter');
  if (whoFilterWrap && !whoFilterWrap._bound){
    whoFilterWrap._bound = true;
    whoFilterWrap.querySelectorAll('input[type="radio"]').forEach(r=>{
      r.onchange = () => { renderAll(); };
    });
  }

  // Helper: choisir une date dans la semaine affichée (week-end autorisé)
  function pickDayInViewAllowWeekend(){
    const monday = mondayOf(weekOffset);
    const weekDays = Array.from({length:7}, (_,i)=> addDaysISO(monday, i));
    const today = todayISO();

    // prendre aujourd’hui s’il est dans la vue
    if (weekDays.includes(today)) return normalizeDueDate(today);

    // sinon, premier jour de la vue normalisé
    return normalizeDueDate(weekDays[0]);
  }

  // -------- Ajouter une tâche
  if (addBtn && !addBtn._bound){
    addBtn._bound = true;
    addBtn.addEventListener('click', ()=>{
      const name = (addName?.value || '').trim();
      let dur  = addDur  ? Number(addDur.value)  : NaN;
      let freq = addFreq ? Number(addFreq.value) : NaN;

      if (!name){ alert('Nom requis'); return; }
      if (!Number.isFinite(dur)  || dur <= 0)  dur  = 30;
      if (!Number.isFinite(freq) || freq <= 0) freq = 7;

      // place la date initiale dans la semaine affichée puis normalise (absences / WE masqués)
      const initialDue = pickDayInViewAllowWeekend();

      tasks.push({
        id: uid(),
        name,
        duration: dur,
        freq,
        nextDue: initialDue
      });

      saveAll();
      rebuildTaskSelectors();
      renderAll();

      if (addName) addName.value = '';
      if (addDur)  addDur.value  = String(dur);
      if (addFreq) addFreq.value = String(freq);
    });
  }

  // -------- Remplir listes édition/suppression
  rebuildTaskSelectors();

  // -------- Changement d’élément à éditer → hydrate les champs (incluant editDue)
  if (editSel && !editSel._bound){
    editSel._bound = true;
    editSel.addEventListener('change', ()=>{
      const idx = Number(editSel.value);
      const t = tasks[idx];
      if (!t) return;
      if (editName) editName.value = t.name || '';
      if (editDur)  editDur.value  = Number(t.duration||0);
      if (editFreq) editFreq.value = Number(t.freq||7);
      if (editDue)  editDue.value  = /^\d{4}-\d{2}-\d{2}$/.test(t.nextDue) ? t.nextDue : '';
    });
  }

  // -------- Enregistrer modification (incluant nextDue normalisé)
  if (saveEdit && !saveEdit._bound){
    saveEdit._bound = true;
    saveEdit.addEventListener('click', ()=>{
      const idx = Number(editSel?.value);
      const t = tasks[idx];
      if (!t){ alert('Choisis une tâche à modifier'); return; }

      const newName = (editName?.value || '').trim();
      let newDur  = editDur  ? Number(editDur.value)  : NaN;
      let newFreq = editFreq ? Number(editFreq.value) : NaN;
      let newDue  = editDue  ? (editDue.value || '').trim() : '';

      if (!newName){ alert('Nom requis'); return; }
      if (!Number.isFinite(newDur)  || newDur <= 0)  newDur  = 30;
      if (!Number.isFinite(newFreq) || newFreq <= 0) newFreq = 7;

      // Validation minimale de la date
      if (newDue){
        const isoRe = /^\d{4}-\d{2}-\d{2}$/;
        if (!isoRe.test(newDue)){
          alert('Format de date invalide (attendu: AAAA-MM-JJ)');
          return;
        }
        // Normalisation selon absences / week-ends masqués
        newDue = normalizeDueDate(newDue);
      } else {
        newDue = t.nextDue; // si vide, on conserve l’ancienne
      }

      t.name = newName;
      t.duration = newDur;
      t.freq = newFreq;
      t.nextDue = newDue;

      saveAll();
      rebuildTaskSelectors(idx);
      renderAll();
    });
  }

  // -------- Supprimer une tâche
  if (delBtn && !delBtn._bound){
    delBtn._bound = true;
    delBtn.addEventListener('click', ()=>{
      const idx = Number(delSel?.value);
      const t = tasks[idx];
      if (!t){ alert('Choisis une tâche à supprimer'); return; }
      if (!confirm(`Supprimer "${t.name}" ?`)) return;

      tasks.splice(idx, 1);
      saveAll();
      rebuildTaskSelectors();
      renderAll();
    });
  }
}

// Remplit editSel / delSel et conserve la sélection si possible
function rebuildTaskSelectors(preserveIndex){
  const editSel  = document.getElementById('editSel');
  const delSel   = document.getElementById('delSel');

  const options = tasks.map((t, i)=> {
    const d = /^\d{4}-\d{2}-\d{2}$/.test(t.nextDue) ? t.nextDue : '';
    return { value: String(i), label: `${t.name} — ${t.duration||0}m · ${t.freq||7}j${d ? ' · '+d : ''}` };
  });

  function fillSelect(sel){
    if (!sel) return;
    const prev = preserveIndex != null ? String(preserveIndex) : sel.value;
    sel.innerHTML = '';
    for (const opt of options){
      const o = document.createElement('option');
      o.value = opt.value; o.textContent = opt.label;
      sel.appendChild(o);
    }
    if (options.length){
      sel.value = (prev && options.some(o=>o.value===prev)) ? prev : '0';
    }
    sel.dispatchEvent(new Event('change'));
  }

  fillSelect(editSel);
  fillSelect(delSel);
}
/***************************************************
 * EXPORT / IMPORT / CLEAR (robuste)
 ***************************************************/
function exportJSON(){
  const data = { tasks, absences, logs, prefs };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'organisation-familiale.json'; a.click();
  URL.revokeObjectURL(url);
}

function importJSON(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange = async ()=>{
    const file = inp.files[0]; if(!file) return;
    const txt = await file.text();
    try{
      const data = JSON.parse(txt);
      const norm = (arr, def=[]) => Array.isArray(arr)?arr:def;
      const obj  = v => (v && typeof v === 'object')? v : {};

      tasks = norm(data.tasks).map(t=>({
        id: (t && typeof t.id==='string' && t.id) ? t.id : uid(),
        name: String(t?.name||'Tâche'),
        duration: Number(t?.duration)||0,
        freq: Number(t?.freq)||7,
        nextDue: /^\d{4}-\d{2}-\d{2}$/.test(String(t?.nextDue)) ? t.nextDue : todayISO()
      }));
      const seen = new Set();
      for(const t of tasks){ if(seen.has(t.id)) t.id = uid(); seen.add(t.id); }

      absences = norm(data.absences).filter(x=>/^\d{4}-\d{2}-\d{2}$/.test(String(x)));
      logs = norm(data.logs).map(l=>({
        date: /^\d{4}-\d{2}-\d{2}$/.test(String(l?.date)) ? l.date : todayISO(),
        taskId: String(l?.taskId||''),
        who: (l?.who==='Yonice'?'Yonice':'Marine'),
        duration: Number(l?.duration)||0
      }));
      prefs = obj(data.prefs);

      saveAll(); refreshSelectors(); renderAll();
    }catch(e){ alert('JSON invalide'); }
  };
  inp.click();
}

function clearAll(){
  if(confirm('Effacer toutes les données locales ?')){
    tasks=[]; absences=[]; logs=[]; prefs={};
    saveAll(); refreshSelectors(); renderAll();
  }
}


function pickDayInViewAllowWeekend(){
  const monday = mondayOf(weekOffset);
  const weekDays = Array.from({length:7}, (_,i)=> addDaysISO(monday, i));
  const isAbsent = d => Array.isArray(absences) && absences.includes(d);

  const today = todayISO();
  if (weekDays.includes(today) && !isAbsent(today)) return today;

  for (const d of weekDays){
    if (!isAbsent(d)) return d;
  }
  // tout est "absent" ? tant pis, on met le lundi de la vue
  return weekDays[0];
}

/***************************************************
 * ÉVENEMENTS SUPPLÉMENTAIRES (clavier)
 ***************************************************/
(function wireKeyboard(){
  document.addEventListener('keydown', (e)=>{
    if((prefs.kbdHints||'on')==='off') return;
    if(e.target && (/^(input|select|textarea)$/i).test(e.target.tagName)) return;
    if(e.key==='y' || e.key==='Y'){ setWhoFilter('y'); }
    else if(e.key==='m' || e.key==='M'){ setWhoFilter('m'); }
    else if(e.key==='a' || e.key==='A'){ setWhoFilter('all'); }
    else if(e.key==='t' || e.key==='T'){ weekOffset=0; saveWeekOffset(); renderWeek(); }
    else if(e.key==='ArrowLeft'){ weekOffset--; saveWeekOffset(); renderWeek(); }
    else if(e.key==='ArrowRight'){ weekOffset++; saveWeekOffset(); renderWeek(); }
  });
})();


refreshSelectors();

</script>
<!-- ===== FIN PARTIE 3/3 -->
</body>
</html>
