<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda hebdomadaire</title>
  <!-- Styles existants conservés, ajout des styles pour les événements Google Calendar -->
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    .week { display: flex; justify-content: space-between; }
    .day { flex: 1; padding: 0.5rem; border: 1px solid #ddd; }
    .day + .day { border-left: none; } /* évite double bordure entre colonnes */
    .day h3 { text-align: center; font-size: 1.1em; margin: 0 0 0.5rem; }
    .task { background: #f9f9f9; padding: 0.25rem 0.5rem; margin: 0.25rem 0; border-left: 4px solid #ccc; }
    /* Couleurs pour les événements de calendrier (Yonice, Marine, Commun) */
    .event.yonice { border-left: 4px solid #2563eb; }
    .event.marine { border-left: 4px solid #facc15; }
    .event.commun { border-left: 4px solid #9b59b6; }
  </style>
  <!-- Script de l'API Google -->
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Agenda hebdomadaire</h1>

  <div class="week">
    <div id="lundi" class="day">
      <h3>Lundi</h3>
      <div class="tasks">
        <div class="task interieur">Arroser les plantes intérieures</div>
        <div class="task exterieur">Sortir les poubelles</div>
      </div>
    </div>
    <div id="mardi" class="day">
      <h3>Mardi</h3>
      <div class="tasks">
        <div class="task interieur">Faire la lessive</div>
        <div class="task exterieur">Faire les courses</div>
      </div>
    </div>
    <div id="mercredi" class="day">
      <h3>Mercredi</h3>
      <div class="tasks">
        <div class="task exterieur">Arroser le jardin</div>
        <div class="task interieur">Nettoyer la cuisine</div>
      </div>
    </div>
    <div id="jeudi" class="day">
      <h3>Jeudi</h3>
      <div class="tasks">
        <div class="task interieur">Nettoyer la salle de bain</div>
        <div class="task loisir">Sortie au parc</div>
      </div>
    </div>
    <div id="vendredi" class="day">
      <h3>Vendredi</h3>
      <div class="tasks">
        <div class="task interieur">Ranger le salon</div>
        <div class="task exterieur">Nettoyer la voiture</div>
      </div>
    </div>
    <div id="samedi" class="day">
      <h3>Samedi</h3>
      <div class="tasks">
        <div class="task exterieur">Tondre la pelouse</div>
        <div class="task loisir">Aller au cinéma</div>
      </div>
    </div>
    <div id="dimanche" class="day">
      <h3>Dimanche</h3>
      <div class="tasks">
        <div class="task loisir">Préparer le repas de famille</div>
        <div class="task loisir">Lecture et repos</div>
      </div>
    </div>
  </div>

  <div class="stats">
    <h2>Statistiques</h2>
    <p>(Contenu des statistiques inchangé)</p>
  </div>

  <div class="absences">
    <h2>Absences</h2>
    <p>(Contenu des absences inchangé)</p>
  </div>

  <script>
    const CLIENT_ID = '691551955911-i6mhvllgop4f1u5q2k144tmqvt6q2pei.apps.googleusercontent.com';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

    function initClient() {
      gapi.client.init({
        clientId: CLIENT_ID,
        scope: SCOPES,
        discoveryDocs: DISCOVERY_DOCS
      }).then(() => {
        // Au chargement, demander la connexion si nécessaire
        if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
          gapi.auth2.getAuthInstance().signIn();
        }
        // Si déjà connecté, charger les événements immédiatement
        if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
          loadCalendarEvents();
        }
        // Écouter les changements d'état de connexion
        gapi.auth2.getAuthInstance().isSignedIn.listen(signedIn => {
          if (signedIn) {
            loadCalendarEvents();
          }
        });
      });
    }

    function loadCalendarEvents() {
      // Nettoyer les événements précédents (si appel répété)
      document.querySelectorAll('.tasks .event').forEach(el => el.remove());

      // Calculer la semaine courante (du lundi au dimanche)
      const now = new Date();
      const today = now.getDay(); // 0 = dimanche, 1 = lundi, ... 6 = samedi
      // Trouver le lundi de la semaine en cours
      const monday = new Date(now);
      monday.setHours(0, 0, 0, 0);
      const diffToMonday = today === 0 ? -6 : 1 - today;
      monday.setDate(now.getDate() + diffToMonday);
      // Lundi suivant pour la fin de la plage (exclu)
      const nextMonday = new Date(monday);
      nextMonday.setDate(monday.getDate() + 7);
      nextMonday.setHours(0, 0, 0, 0);

      const timeMin = monday.toISOString();
      const timeMax = nextMonday.toISOString();

      const calendars = [
        { id: 'moissonnieryonice@gmail.com', className: 'yonice' },
        { id: 'marine.penon38@gmail.com', className: 'marine' },
        { id: 'marineetyonice@gmail.com', className: 'commun' }
      ];

      calendars.forEach(cal => {
        gapi.client.calendar.events.list({
          calendarId: cal.id,
          timeMin: timeMin,
          timeMax: timeMax,
          singleEvents: true,
          orderBy: 'startTime'
        }).then(response => {
          const events = response.result.items;
          if (events && events.length > 0) {
            events.forEach(event => {
              // Récupérer la date/heure de début de l'événement
              let start = event.start.dateTime || event.start.date;
              let eventDate = new Date(start);
              // Ajuster si événement sur la journée entière (date uniquement)
              if (event.start.date && !event.start.dateTime) {
                // Utiliser midi pour éviter les décalages de fuseau horaire
                eventDate = new Date(event.start.date + 'T12:00:00');
              }
              const dayIndex = eventDate.getDay(); // jour de la semaine (0-6)
              // Identifier la colonne du jour correspondante
              let dayId = '';
              switch (dayIndex) {
                case 0: dayId = 'dimanche'; break;
                case 1: dayId = 'lundi'; break;
                case 2: dayId = 'mardi'; break;
                case 3: dayId = 'mercredi'; break;
                case 4: dayId = 'jeudi'; break;
                case 5: dayId = 'vendredi'; break;
                case 6: dayId = 'samedi'; break;
              }
              if (dayId) {
                const container = document.querySelector('#' + dayId + ' .tasks');
                if (container) {
                  // Créer l'élément pour l'événement
                  const eventEl = document.createElement('div');
                  eventEl.className = 'task event ' + cal.className;
                  // Formater l'heure si ce n'est pas un événement "journée entière"
                  let timeText = '';
                  if (event.start.dateTime) {
                    const eventTime = new Date(event.start.dateTime);
                    timeText = eventTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) + ' - ';
                  }
                  const title = event.summary || '(Sans titre)';
                  eventEl.textContent = timeText + title;
                  container.appendChild(eventEl);
                }
              }
            });
          }
        }, error => {
          console.error('Erreur lors du chargement des événements pour ' + cal.id, error);
        });
      });
    }

    // Charger le client Google API et la librairie d'authentification OAuth 2.0, puis initier
    gapi.load('client:auth2', initClient);
  </script>
</body>
</html>
